<!DOCTYPE html>
<html>
<head>
  <title>Mastering Node</title>
  <meta name="description" content="Mastering Node" />
  <meta name="keywords" content="node.js,node,Mastering Node,JavaScript" />
  <meta name="author" content="TJ Holowaychuk, et al." />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />  
  <script type="text/javascript" src="https://raw.github.com/jimschubert/masteringnode/master/pages/prettify.js"></script>
  <style type="text/css">
  /*--------------------- Layout and Typography ----------------------------*/
body {
font-family: "Helvetica Neue", Helvetica, FreeSans, Arial, sans-serif;
/*  font-family: Georgia, FreeSerif, Times, serif; */
font-size: 0.9375em;
line-height: 1.4667em;
color: #222;
margin: 0; padding: 0;
}
a {
color: #0050c0;
text-decoration: underline;
}
a:visited {
color: #b950b7;
text-decoration: underline;
}
a:hover, a:focus {
text-decoration: none;
}

code a:hover {
background: none;
color: #b950b7;
}

#changelog #gtoc {
display: none;
}

.notice {
display: block;
padding: 1em;
margin: 1.4667em 0 2.9334em;
background:#FFF6BF;
color:#514721;
border:1px solid #FFD324;
}
.notice p {
margin: 0;
}

ul.plain {
list-style: none;
}

abbr {
border-bottom: 1px dotted #454545;
}

p {
margin: 0 0 1.4667em 0;
position: relative;
text-rendering: optimizeLegibility;
}

ol, ul, dl {
margin: 0 0 1em 0;
padding: 0;
}

ol ul, ol ol, ol dl,
ul ul, ul ol, ul dl,
dl ul, dl ol, dl dl {
margin-bottom: 0;
}

ol p:first-child, ul p:first-child, dl p:first-child {
margin-bottom: 0;
}

ul, ol {
margin-left: 2em;
}


dl dt {
position: relative;
margin: 1.5em 0 0;
}

dl dd {
position: relative;
margin: 0 1em 0;
}

dd + dt.pre {
margin-top: 1.6em;
}

h1, h2, h3, h4, h5, h6 {
font-family: Georgia, FreeSerif, Times, serif;
color: #000;
text-rendering: optimizeLegibility;
position: relative;
}

h1 {
font-size: 2.55em;
line-height: 1.375em;
}

h2 {
font-size: 1.9em;
line-height: 1.227em;
margin: 0 0 0.5em;
}

h3 {
font-size: 1.5em;
line-height: 1.0909em;
margin: 1.5em 0 0.5em;
}

h3 + h3 {
margin: 0 0 0.5em;
}

h4 {
font-size: 1.3em;
line-height: 1.1282em;
margin: 2.2em 0 0.5em;
}

h4 + h4 {
margin: 0 0 0.5em;
}

h5 {
font-size: 1.125em;
line-height: 1.4em;
}

h6 {
font-size: 1em;
line-height: 1.4667em;
}

pre, tt, code {
font-size: 0.95em;
line-height: 1.5438em;
font-family: Monaco, Consolas, "Lucida Console", monospace;
margin: 0; padding: 0;
}

.pre {
font-family: Monaco, Consolas, "Lucida Console", monospace;
line-height: 1.5438em;
font-size: 0.95em;
}

pre {
padding: 2em 1.6em 2em 1.2em;
vertical-align: top;
background: #f8f8f8;
border: 1px solid #e8e8e8;
border-width: 1px 1px 1px 6px;
margin: -0.5em 0 1.1em;
}

pre + h3 {
margin-top: 2.225em;
}

code.pre {
white-space: pre;
}

#container {
position: relative;
padding: 6em;
max-width: 50em;
text-align: left;
}

#container header {
margin: 1.25em -0.5em 1.3em;
padding: 0 0.5em 0.225em;
}

hr {
background: none;
border: medium none;
border-bottom: 1px solid #ccc;
margin: 5em 0 2em;
}

#container header hr {
margin: 0;
padding: 0;
}

#toc {

}

#toc h2 {
font-size: 1em;
line-height: 1.4em;
}

#toc h2 a {
float: right;
}

#toc hr {
margin: 1em 0 2em;
}

p tt, p code {
background: #f8f8ff;
border: 1px solid #dedede;
padding: 0 0.2em;
}

a.octothorpe {
text-decoration: none;
color: #777;
position: absolute;
top: 0; left: -1.4em;
padding: 1px 2px;
opacity: 0;
-webkit-transition: opacity 0.2s linear;
}
p:hover  > a.octothorpe, 
dt:hover > a.octothorpe,
dd:hover > a.octothorpe,
h1:hover > a.octothorpe,
h2:hover > a.octothorpe,
h3:hover > a.octothorpe,
h4:hover > a.octothorpe,
h5:hover > a.octothorpe,
h6:hover > a.octothorpe {
opacity: 1;
}


/* Pretty printing styles. Used with prettify.js. */

/* SPAN elements with the classes below are added by prettyprint. */
.pln { color: #000 }  /* plain text */

@media screen {
  .str { color: #080 }  /* string content */
  .kwd { color: #008 }  /* a keyword */
  .com { color: #800 }  /* a comment */
  .typ { color: #606 }  /* a type name */
  .lit { color: #066 }  /* a literal value */
  /* punctuation, lisp open bracket, lisp close bracket */
  .pun, .opn, .clo { color: #660 }
  .tag { color: #008 }  /* a markup tag name */
  .atn { color: #606 }  /* a markup attribute name */
  .atv { color: #080 }  /* a markup attribute value */
  .dec, .var { color: #606 }  /* a declaration; a variable name */
  .fun { color: red }  /* a function name */
}

/* Use higher contrast and text-weight for printable form. */
@media print, projection {
  .str { color: #060 }
  .kwd { color: #006; font-weight: bold }
  .com { color: #600; font-style: italic }
  .typ { color: #404; font-weight: bold }
  .lit { color: #044 }
  .pun, .opn, .clo { color: #440 }
  .tag { color: #006; font-weight: bold }
  .atn { color: #404 }
  .atv { color: #060 }
}

/* Put a border around prettyprinted code snippets. */
pre.prettyprint { padding: 2px; border: 1px solid #888 }

/* Specify class=linenums on a pre to get line numbering */
ol.linenums { margin-top: 0; margin-bottom: 0 } /* IE indents via margin-left */
li.L0,
li.L1,
li.L2,
li.L3,
li.L5,
li.L6,
li.L7,
li.L8 { list-style-type: none }
/* Alternate shading for lines */
li.L1,
li.L3,
li.L5,
li.L7,
li.L9 { background: #eee }

  </style>
</head>
<body>
<img style="display:none;" width="810" height="813" title="" alt="" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAMtAyoDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD0uikzRmvzozuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuLRSZozQFxaKTNGaAuNzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigAzRmiigBKKbRTEOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQAlFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAmaM0lFMBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooASikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAWikooAbRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUAJRSZozTsMWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WAWikzRmiwC0UmaM0WATNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoAXNGaTNGaAFzRmkzRmgBc0ZpM0ZoASikzRmmAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ANoozRmgQUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAUUZozQAlFNopgOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQA6im0UAOoptFADqKbRQAlFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQAtFJRQA2ikopgLRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUALRSUUAJRTaKdgHUU2iiwDqKbRRYB1FNoosA6im0UWAdRTaKLAOoptFFgHUU2iiwDqKbRRYB1FNoosA6im0UWAdRTaKLAOoptFFgHUU2iiwDqKbRRYB1FNoosA6im0UWAdRTaKLAOoptFFgHUU2iiwDqKbR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AdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoAdRTc0ZoASikzRmmAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0AMzRmkopgLmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFACUUlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFAC0UlFACZozTc0ZpgOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADs0ZpuaM0AOzRmm5ozQA7NGabmjNADc0ZpKKYxc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAbRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0ALRSZozQAtFJmjNAC0UmaM0AJmjNJmjNMQuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNACUUlFMBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBaKSigBM0ZpM0ZoGLmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQA3NGaTNGaYC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0AJmjNJRTAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAEzRmkzRmgQuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNAC5ozSZozQAuaM0maM0ALmjNJmjNACZozSUUwFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBc0ZpKKAFzRmkooAXNGaSigBM0ZpKKBi5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAmaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAuaM0lFAC5ozSUUALmjNJRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQB//Z" />
  <div id="container"> 
<div style="display:none"><!-- all --></div>
<h1>Mastering Node</h1>

<p><a href="http://nodejs.org">Node</a> is an exciting new platform developed by <em>Ryan Dahl</em>, allowing JavaScript developers to create extremely high performance servers by leveraging <a href="http://code.google.com/p/v8/">Google V8</a> JavaScript engine, and asynchronous I/O. In <em>Mastering Node</em>) we will discover how to write high concurrency web servers, utilizing the CommonJS module system, node&#39;s core libraries, third party modules, high level web development and more.</p>

<h2 id="why_Node_">Why Node?</h2>

<p>Node is an evented I/O framework for server-side JavaScript.  What does that mean, though?  In many programming languages, I/O operations are blocking.  This means that when you open a file, no other code executes until that file is fully opened.  </p>

<p>Using a busy office environment as an example, blocking I/O operations are like a very busy and very focussed desk worker name Frank. Work may pile up on the desk, but Frank finishes every task that he starts (however, when he finds the smallest problem, he gives up).  This is traditionally how procedural programming languages perform tasks.</p>

<p>Node.js is more like an office manager. Sure, there are management tasks, but all of those I/O operations are handled fairly well by the operating system or node addons.  So, the manager sees a task, assigns it to Frank.  The manager may check back on Frank from time to time to see how he&#39;s doing, but he doesn&#39;t need to waste his time on the task because he knows that when it&#39;s completed, Frank will give it back.</p>

<p>Don&#39;t worry, though.  Node.js isn&#39;t a jerk, so look forward to a healthy relationship.</p>

<h2 id="why_JavaScript_">Why JavaScript?</h2>

<p><strong>JavaScript is a well-known dynamic language.</strong></p>

<p>In fact, many people who don&#39;t consider themselves programmers know JavaScript. Node.js uses <a href="http://code.google.com/apis/v8/intro.html">Google&#39;s V8 JavaScript engine</a>.  V8 is an implementation of the JavaScript standards specified in <a href="http://www.ecma-international.org/publications/files/ECMA-ST-ARCH/ECMA-262,%203rd%20edition,%20December%201999.pdf">ECMA-262, Version 3</a>. It is a high-performance, garbage-collected execution environment which can be embedded in any stand-alone application.</p>

<p><strong>Everything in JavaScript is an <code>Object</code>.</strong></p>

<p>Arrays are <code>Objects</code>.  Object literals are <code>Object</code>s.  Even functions are <code>Object</code>s.</p>

<p><strong>JavaScript supports some fairly advanced functional programming concepts. <a href="http://www.ibm.com/developerworks/library/wa-javascript.html#functional">?</a></strong></p>

<p>Currying, closures, functions-as-arguments, and anonymous functions are concepts typically found in functional programming languages.  There are libraries available, such as <a href="http://documentcloud.github.com/underscore/">underscore.js</a>, which provider more functional programming functionality without changing JavaScript itself.</p>

<p><strong>It&#39;s awesome. I had to say it.</strong></p>

<p>For a deep understanding of what JavaScript really has to offer, check out <a href="http://oreilly.com/catalog/9780596806767">JavaScript Patterns</a>.</p>

<h2 id="hello_World_">Hello World!</h2>

<p><strong>Becuase it has to be done</strong></p>

<pre class="prettyprint"><code>// hello.js
sys = require(&#39;sys&#39;);
sys.puts(&quot;Hello, World!&quot;);</code></pre>

<p>To run the &#39;Hello, World!&#39; example, execute <code>node hello.js</code> on the command line.</p>

<h2 id="conventions_in_this_book">Conventions in this book</h2>

<p><strong>Code Blocks</strong></p>

<p>There are a few conventions used in the code example blocks (such as the Hello, World! example above).</p>

<p>First, if the example is a script (or a part of a script) that needs to be run from the command line, it will begin with a <code>//</code> styled comment of the filename.  These files are located under the <code>./src</code> directory of the <em>Mastering Node</em> project.  Running these examples is fairly simple: open a terminal (CTRL+SHIFT+T might do it) and type <code>node</code> followed by a space and the relative path of the script.  In other words, if you&#39;re in <em>/home/jim/masteringnode</em> and you want to run a script under <em>/home/jim/masteringnode/scripts/</em> which is called <em>hello.js</em>, you would run <code>node scripts/hello.js</code> or <code>node ./scripts/hello.js</code>.  For an example of how this code snippet is displayed, see the Hello, World! example above.</p>

<p>Second, if the example is a command to be entered directly into what will be referred to as a &#39;node terminal&#39;, you should first open a terminal then type <code>node</code> and ENTER (assuming the node executable is in your PATH variable, and is called node).  At the prompt, you should enter the commands following the <code>&gt;</code> character. Text following the <code>&gt;</code> character are commands you should enter, while text on a line that does not begin with <code>&gt;</code> is the output.  This is done to closely match what you should see in your terminal.  These examples are not included in files under the <em>src</em> directory.  For instance:</p>

<pre class="prettyprint"><code>&gt; console.log(&quot;Hello, World!&quot;)
Hello, World.</code></pre>

<p>Third, if an example is to be run from the terminal itself, it is prefixed by a <code>$</code>.  This represents a bash environment, and may look differently depending on your configuration.  For instance, my bash terminal displays:</p>

<pre class="prettyprint"><code>jim@cr-48:~/projects/masteringnode$</code></pre>

<p>These code examples will look like this:</p>

<pre class="prettyprint"><code>$ ruby -e &quot;puts &#39;Hello, World&#39;&quot;</code></pre>

<p>Finally, code without a prefix is a sample of a possible solution or expected output from <em>stdout</em>.  This is not necessarily code you should type into your terminal or run as a script, unless of course you want to experiment.  For example, suppose we&#39;re discussing CommonJS and we&#39;d like to show how something <em>would</em> be done in CommonJS, we might show an example such as:</p>

<pre class="prettyprint"><code>var utils = {};
utils.merge = function(obj, other) {};</code></pre>

<p>This wouldn&#39;t contain a filename unless there is a working example (in which case, it&#39;s a concrete example and no longer hypothetical).</p>

<p><strong>Inline Code</strong></p>

<p>Occasionally, there will be code or commands that are being explained and displayed inline to separate them visually from the rest of the sentence.  For instance, if we were talking about how to include modules into your code, we may say to add a <code>var fs = require(&#39;fs&#39;);</code> line to the top of your file.  Code displayed like this is generally accompanied by an explanation of the code itself or instructions for where to add the code.  </p>

<p>Functions may be displayed as <code>require()</code> or <code>require</code>, depending on the context for readability. That is, when we&#39;re talking about any JavaScript objects, we&#39;ll most likely use <code>require</code> since a function is also an object.  </p>

<p>If we&#39;re talking about multiple functions, we may say &quot;use the functions: <code>doSomething1</code> and <code>doSomething2</code>&quot; instead of &quot;use the functions: <code>doSomething1()</code> and <code>doSomething2()</code>&quot; because the parentheses can be implied and the absence of parentheses is easier on the eyes.</p>

<p><strong>Files and Directories</strong></p>

<p>Files and directories will be displayed in italics when inline, or as a relative path to the <em>Mastering Node</em> source directory in code comments when in a code example block.  For instance, if we reference <em>/home/jim/masteringnode/src/modules/fake.js</em> in a code example, it will look like:</p>

<pre class="prettyprint"><code>// modules/fake.js
var num = 1;</code></pre>

<h1>Installing Node</h1>

<p>In this chapter we will be looking at the installation and compilation of node. Although there are several ways we may install node, we will be looking at <a href="http://github.com/mxcl/homebrew">homebrew</a>, and the most flexible method, of course - compiling from source.</p>

<h3 id="homebrew">Homebrew</h3>

<p>Homebrew is a package management system for <em>OSX</em> written in Ruby, is extremely well adopted, and easy to use.  Homebrew can be installed in a number of ways.  Possibly the easiest way is to perform a quick install to <code>/usr/local/</code>:</p>

<pre class="prettyprint"><code>$ ruby -e &quot;$(curl -fsSL https://gist.github.com/raw/323731/install_homebrew.rb)&quot;</code></pre>

<p>Next, to install node via the <code>brew</code> executable, simply run:</p>

<pre class="prettyprint"><code>$ brew install node.js</code></pre>

<p>For more information on packages and commands available to homebrew, checkout the README at github.</p>

<h2 id="building_From_Source">Building From Source</h2>

<p>To build and install node from source, we first need to obtain the code. The first method of doing so is
via <code>git</code>, if you have git installed you can execute:</p>

<pre class="prettyprint"><code>$ git clone http://github.com/joyent/node.git &amp;&amp; cd node
$ git checkout v0.4.0</code></pre>

<p>For those without <em>git</em>, or who prefer not to use it, we can also download the source via <em>curl</em>, <em>wget</em>, or similar:</p>

<pre class="prettyprint"><code>$ curl -# http://nodejs.org/dist/node-v0.4.0.tar.gz &gt; node.tar.gz
$ tar -zxf node.tar.gz</code></pre>

<p>Now that we have the source on our machine, we can run <code>./configure</code> which discovers which libraries are available for node to utilize such as <em>OpenSSL</em> for transport security support, C and C++ compilers, etc. <code>make</code> which builds node, and finally <code>make install</code> which will install node.</p>

<pre class="prettyprint"><code>$ ./configure &amp;&amp; make &amp;&amp; sudo make install</code></pre>

<h2 id="installing_from_Distribution_Sources">Installing from Distribution Sources</h2>

<p>Installing node.js from a distribution&#39;s repositories is not highly recommended.  This is because the version included with your distribution may be very outdated.  As an example, the original version of this document was written to target node.js 0.1.99.  In Ubuntu 10.10, the version of node.js included in the official repository is 0.1.97-1build1.  Because node.js is a relatively young project with a large community, changes to the API occur quickly and often.</p>

<p>If you still wish to install nodejs from an official repository, it can be done in the usual way:</p>

<pre class="prettyprint"><code>$ sudo apt-get install nodejs
$ yum install nodejs</code></pre>

<p>Refer to your distribution&#39;s documention or wiki for the proper commannd for installation from the official repository.</p>

<h3 id="npm_Node_Package_Manager">npm: Node Package Manager</h3>

<p>npm is a node package manager with a relatively large category of available modules.  To install directly in one line, run:</p>

<pre class="prettyprint"><code>$ curl http://npmjs.org/install.sh | sh</code></pre>

<p>If this one-liner fails, run:</p>

<pre class="prettyprint"><code>$ git clone http://github.com/isaacs/npm.git
$ cd npm
$ sudo make install</code></pre>

<p>For more information on npm, check out the <a href="https://github.com/isaacs/npm">repo</a>.</p>

<h2 id="installing_other_packages">Installing other packages</h2>

<p>Using npm, we&#39;ll install other packages needed for the examples in this book.</p>

<pre class="prettyprint"><code>$ sudo npm install connect express nodeunit geddy zombie node-inspector</code></pre>

<p>Let npm do it&#39;s thing.  It will install these modules any any dependencies.  You&#39;ll see output similar to the following:</p>

<pre class="prettyprint"><code>npm info activate jsdom@0.1.23
npm info postactivate jsdom@0.1.23
npm info build Success: express@1.0.7
npm info build Success: nodeunit@0.5.1
npm info build Success: mime@1.2.1
npm info build Success: geddy@0.1.3
npm info build Success: websocket-client@1.0.0
npm info build Success: connect@1.0.1</code></pre>

<h2 id="setting_up_an_editor">Setting up an editor</h2>

<p>Part of setting up a development environment is using the right tools.  While some may prefer a full IDE, others will go with a very simple text editor.  I enjoy using <em>vim</em>, and this is my <em>~/.vimrc</em> file&#39;s contents:</p>

<pre class="prettyprint"><code>syntax on &quot; enabled syntax highlighting
:set number &quot; line numbers
:set ai &quot; autoindent
:set tabstop=4 &quot; sets tabs to 4 characters
:set shiftwidth=4
:set expandtab
:set softtabstop=4 &quot; makes the spaces feel like real tabs

&quot; CSS (tabs = 2, lines = 79)
autocmd FileType css set omnifunc=csscomplete#CompleteCSS
autocmd FileType css set sw=2
autocmd FileType css set ts=2
autocmd FileType css set sts=2

&quot; JavaScript (tabs = 4, lines = 79)
autocmd FileType javascript set omnifunc=javascriptcomplete#CompleteJS
autocmd FileType javascript set sw=4
autocmd FileType javascript set ts=4
autocmd FileType javascript set sts=4
&quot; autocmd FileType javascript set tw=79

&quot; Jade
autocmd FileType jade set omnifunc=jadecomplete#CompleteJade
autocmd FileType jade set sw=2
autocmd FileType jade set ts=2
autocmd FileType jade set sts=2

&quot; ejs
autocmd FileType ejs set sw=2
autocmd FileType ejs set ts=2
autocmd FileType ejs set sts=2

&quot; Highlight current line only in insert mode
autocmd InsertLeave * set nocursorline
autocmd InsertEnter * set cursorline

&quot; Makefiles require TAB instead of whitespace
autocmd FileType make setlocal noexpandtab

&quot; Highlight cursor
highlight CursorLine ctermbg=8 cterm=NONE</code></pre>

<p>If your install of <em>vim</em> doesn&#39;t include the <em>*complete</em> functions, you can download them from <a href="http://www.vim.org/scripts/index.php">vim.org/scripts</a>.  Most likely, you&#39;ll need the <a href="http://www.vim.org/scripts/script.php?script_id=3192">jade.vim</a> script.</p>

<p>Other excellent IDEs include:</p>

<ol><li><a href="http://cloud9ide.com/">cloud9 IDE</a></li><li><a href="http://www.geany.org/">geany</a></li><li><a href="http://aptana.org/">Aptana Studio</a></li></ol>

<h1>Debugging</h1>

<p>One of the most important aspects of programming in any language is the ability to debug code.</p>

<h2 id="node_inspector">node-inspector</h2>

<p><a href="https://github.com/dannycoates/node-inspector">node-inspector</a> is a Web Inspector node.js debugger.  This means you&#39;ll need a WebKit browser like Chrome or Safari to run node-inspector.</p>

<h2 id="installation">Installation</h2>

<p>If you&#39;ve performed the npm installation from the previous section, you should be ready to go.  If not, you can install node-inspector from source or through npm.</p>

<pre class="prettyprint"><code>$ npm install node-inspector</code></pre>

<p>If you&#39;d like to install from source, check out the <a href="https://github.com/dannycoates/node-inspector/wiki/Getting-Started---from-scratch">Getting Started from scratch</a> wiki entry from the node-inspector repository.</p>

<h2 id="usage">Usage</h2>

<p>Open one terminal to host a node-inspector server.  This terminal will remain open and provide a debug listener.</p>

<pre class="prettyprint"><code>$ node-inspector&amp;
&gt; visit http://0.0.0.0:8080/debug?port=5858 to start debugging</code></pre>

<p>You will see output directing you to open a browser and point it to the node-inspector server at the default port (8080).</p>

<p>Next, open another terminal and navigate to <code>./src/events</code> and run node with the <code>--debug-brk</code> switch.  This will connect to the debugger on port 5858.</p>

<pre class="prettyprint"><code>$ node --debug-brk basic.js 
&gt; debugger listening on port 5858</code></pre>

<p>Now, open a browser to <a href="http://127.0.0.1:8080/debug?port=5858">http://127.0.0.1:8080/debug?port=5858</a> and you will see a breakpoint on what would be the first line of your file.  I phrased it like this intentionally because the debugger shows you how node.js sees your file:</p>

<pre class="prettyprint"><code>(function (exports, require, module, filename, dirname) {
/* Your code here */
});</code></pre>

<p>If you&#39;ve used the Web Inspector view in Google Chrome, you should be familiar with using node-inspector&#39;s version of Web Inspector.  There is a console drawer if you click on the bottom-left icon which allows you to evaluate JavaScript and filter log messages by type (Errors, Warnings, Logs). There is also a &#39;Console&#39; tab if you need a full view of the console.</p>

<p>Expand the <code>Watch Expressions</code> section on the right of the Web Inspector&#39;s Scripts tab.  Click the &#39;Add&#39; button and you can add variables which will be updated as you step through code.  In version 0.1.6 of node-inspector, when I click the &#39;Add&#39; button, it automatically adds two single-quotes.  If this happens to you, delete the quotes and enter your text.</p>

<p>You&#39;ll see as you step through the code that you step directly into node.js functions.  This is very useful if you are exploring node.js or if you want to see how something is implemented, like when you call something like <code>console.log(&quot;%d days without incident&quot;, 5);</code>.</p>

<h1>CommonJS Module System</h1>

<p><a href="http://commonjs.org">CommonJS</a> is a community driven effort to standardize packaging of JavaScript libraries, known as <em>modules</em>. Modules written which comply to this standard provide portability between other compliant frameworks such as narwhal, and in some cases even browsers. </p>

<p>Although this is ideal, in practice modules are often not portable due to relying on apis that are currently only provided by, or are tailored to node specifically. As the framework matures, and additional standards emerge our modules will become more portable.  </p>

<h2 id="creating_Modules">Creating Modules</h2>

<p>Let&#39;s create a utility module named <em>utils</em>, which will contain a <code>merge()</code> function to copy the properties of one object to another. Typically in a browser, or environment without CommonJS module support, this may look similar to below, where <code>utils</code> is a global variable. </p>

<pre class="prettyprint"><code>var utils = {};
utils.merge = function(obj, other) {};</code></pre>

<p>Although namespacing can lower the chance of collisions, it can still become an issue, and when further namespacing is applied it can look flat-out silly. CommonJS modules aid in removing this issue by &quot;wrapping&quot; the contents of a JavaScript file with a closure similar to what is shown below, however more pseudo globals are available to the module in addition to <code>exports</code>, <code>require</code>, and <code>module</code>. The <code>exports</code> object is then returned when a user invokes <code>require(&#39;utils&#39;)</code>.</p>

<pre class="prettyprint"><code>var module = { exports: {}};
  (function(module, exports){
      function merge(){};
      exports.merge = merge;
  })(module, module.exports);</code></pre>

<p>First create the file <em>./modules/utils.js</em>, and define the <code>merge()</code> function as seen below. The implied anonymous wrapper function shown above allows us to seemingly define globals, however these are not accessible until exported. </p>

<pre class="prettyprint"><code>function merge(obj, other) {
  var keys = Object.keys(other);
  for (var i = 0, len = keys.length; i &lt; len; ++i) {
    var key = keys[i];
    obj[key] = other[key];
  }
  return obj;
};

exports.merge = merge;</code></pre>

<p>The typical pattern for public properties is to simply define them on the <code>exports</code> object like so:</p>

<pre class="prettyprint"><code>// modules/utils.js
exports.merge = function(obj, other) {
  var keys = Object.keys(other);
  for (var i = 0, len = keys.length; i &lt; len; ++i) {
      var key = keys[i];
      obj[key] = other[key];
  }
  return obj;
};</code></pre>

<p>Next we will look at utilizing out new module in other libraries.</p>

<h2 id="requiring_Modules">Requiring Modules</h2>

<p>To get started with requiring modules, first create a second file named <em>./modules/app.js</em> with the code shown below. The first line <code>require(&#39;./utils&#39;)</code> fetches the contents of <em>./modules/utils.js</em> and returns the <code>exports</code> of which we later utilize our <code>merge()</code> method and display the results of our merged object using <code>console.dir()</code>.</p>

<pre class="prettyprint"><code>// modules/app.js
var utils = require(&#39;./utils&#39;);

var a = { one: 1 };
var b = { two: 2 };
utils.merge(a, b);
console.dir(a);</code></pre>

<p>Core modules such as the <em>sys</em> which are bundled with node can be required without a path, such as <code>require(&#39;sys&#39;)</code>, however 3rd-party modules will iterate the <code>require.paths</code> array in search of a module matching the given path. By default <code>require.paths</code> includes <em>~/.node_libraries</em>, so if <em>~/.node_libraries/utils.js</em> exists we may simply <code>require(&#39;utils&#39;)</code>, instead of our relative example <code>require(&#39;./utils&#39;)</code> shown above.</p>

<p>Node also supports the concept of <em>index</em> JavaScript files. To illustrate this example lets create a <em>math</em> module that will provide the <code>math.add()</code>, and <code>math.sub()</code> methods. For organizational purposes we will keep each method in their respective <em>./modules/math/add.js</em> and <em>./modules/math/sub.js</em> files. So where does <em>index.js</em> come into play? we can populate <em>./modules/math/index.js</em> with the code shown below, which is used when <code>require(&#39;./math&#39;)</code> is invoked, which is conceptually identical to invoking <code>require(&#39;./math/index&#39;)</code>.</p>

<pre class="prettyprint"><code>// modules/util.js
module.exports = {
    add: require(&#39;./add&#39;),
    sub: require(&#39;./sub&#39;)
};</code></pre>

<p>The contents of <em>./modules/math/add.js</em> show us a new technique; here we use <code>module.exports</code> instead of <code>exports</code>.  As previously mentioned, <code>exports</code> is not the only object exposed to the module file when evaluated. We also have access to <code>__dirname</code>, <code>__filename</code>, and <code>module</code> which represents the current module. We simply define the module export object to a new object, which happens to be a function. </p>

<pre class="prettyprint"><code>// modules/math/add.js
module.exports = function add(a, b){
    return a + b;
};</code></pre>

<p>This technique is usually only helpful when your module has one aspect that it wishes to expose, be it a single function, constructor, string, etc. Below is an example of how we could provide the <code>Animal</code> constructor:</p>

<pre class="prettyprint"><code>exports.Animal = function Animal(){};</code></pre>

<p>which can then be utilized as shown:</p>

<pre class="prettyprint"><code>var Animal = require(&#39;./animal&#39;).Animal;</code></pre>

<p>if we change our module slightly, we can remove <code>.Animal</code>:</p>

<pre class="prettyprint"><code>module.exports = function Animal(){};</code></pre>

<p>which can now be used without the property:</p>

<pre class="prettyprint"><code>var Animal = require(&#39;./animal&#39;);</code></pre>

<h2 id="require_Paths">Require Paths</h2>

<p>We talked about <code>require.paths</code>, the <code>Array</code> utilized by node&#39;s module system in order to discover modules. By default, node checks the following directories for modules:</p>

<ul><li><code>&lt;node binary&gt;</code>/../../lib/node</li><li><strong>$HOME</strong>/.node_libraries</li><li><strong>$NODE_PATH</strong></li></ul>

<p>The <strong>NODE_PATH</strong> environment variable is much like <strong>PATH</strong>, as it allows several paths delimited by the colon (<code>:</code>) character.</p>

<h3 id="runtime_Manipulation">Runtime Manipulation</h3>

<p>Since <code>require.paths</code> is just an array, we can manipulate it at runtime in order to expose libraries. In our previous example we defined the libraries <em>./math/{add,sub}.js</em>, in which we would typically <code>require(&#39;./math&#39;)</code> or <code>require(&#39;./math/add&#39;)</code> etc. Another approach is to prepend or &quot;unshift&quot; a directory onto <code>require.paths</code> as shown below, after which we can simply <code>require(&#39;add&#39;)</code> since node will iterate the paths in order to try and locate the module.</p>

<pre class="prettyprint"><code>require.paths.unshift(__dirname + &#39;/math&#39;);

var add = require(&#39;add&#39;),
    sub = require(&#39;sub&#39;);

console.log(add(1,2));
console.log(sub(1,2));</code></pre>

<h2 id="pseudo_Globals">Pseudo Globals</h2>

<p>As mentioned above, modules have several pseudo globals available to them, these are as follows:</p>

<ul><li><code>require</code> the require function itself </li><li><code>module</code> the current <code>Module</code> instance</li><li><code>exports</code> the current module&#39;s exported properties</li><li><code>__filename</code> absolute path to the current module&#39;s file</li><li><code>__dirname</code> absolute path to the current module&#39;s directory</li></ul>

<p>To examine the functionality of <code>require</code>, <code>module</code>, and <code>exports</code>, open a node console by running the command <code>node</code>.  You should then enter a node prompt as seen below:</p>

<pre class="prettyprint"><code>$ node
&gt; </code></pre>

<p>To view these objects, enter the following commands into node:</p>

<pre class="prettyprint"><code>&gt; require
&gt; module
&gt; module.exports
&gt; module.filename</code></pre>

<p>If you&#39;d like to examine other objects, the node console supports the well-known <code>&lt;TAB&gt;</code><code>&lt;TAB&gt;</code> auto-completion. </p>

<h3 id="require">require()</h3>

<p>Although not obvious at first glance, the <code>require()</code> function is actually re-defined for the current module, and calls an internal function <code>loadModule</code> with a reference to the current <code>Module</code> to resolve relative paths and to populate <code>module.parent</code>.</p>

<h3 id="module">module</h3>

<p>When we <code>require()</code> a module, typically we only deal with the module&#39;s <code>exports</code>, however the <code>module</code> variable references the current module&#39;s <code>Module</code> instance. This is why the following is valid, as we may re-assign the module&#39;s <code>exports</code> to any object, even something trivial like a string:</p>

<pre class="prettyprint"><code>// modules/css.js
module.exports = &#39;body { background: blue; }&#39;;</code></pre>

<p>To obtain this string we would simply <code>require(&#39;./css&#39;)</code>. The <code>module</code> object also contains these useful properties:</p>

<ul><li><code>id</code> the module&#39;s id, consisting of a path. Ex: <code>./app</code></li><li><code>parent</code> the parent <code>Module</code> (which required this one) or <code>undefined</code></li><li><code>filename</code> absolute path to the module</li><li><code>moduleCache</code> an object containing references to all cached modules</li></ul>

<h2 id="registering_Module_Compilers">Registering Module Compilers</h2>

<p>Another cool feature that node provides us is the ability to register compilers for a specific file extension. A good example of this is the CoffeeScript language, which is a ruby/python inspired language compiling to vanilla JavaScript. By using <code>require.registerExtension()</code> we can have node compile CoffeeScript to JavaScript in an automated fashion. </p>

<p>To illustrate its usage, let&#39;s create a small (and useless) Extended JavaScript language, or &quot;ejs&quot; for our example which will live at <em>./modules/compiler/example.ejs</em>, its syntax will look like this:</p>

<pre class="prettyprint"><code>// modules/compiler/example.ejs
::min(a, b) a &lt; b ? a : b
::max(a, b) a &gt; b ? a : b</code></pre>

<p>which will be compiled to:</p>

<pre class="prettyprint"><code>exports.min = function min(a, b) { return a &lt; b ? a : b }
exports.max = function max(a, b) { return a &gt; b ? a : b }</code></pre>

<p>First let&#39;s create the module that will actually be doing the ejs to JavaScript compilation. In this example it is located at <em>./modules/compiler/extended.js</em>, and exports a single method named <code>compile()</code>. This method accepts a string, which is the raw contents of what node is requiring, transformed to vanilla JavaScript via regular expressions.</p>

<pre class="prettyprint"><code>// modules/compiler/extended.js
exports.compile = function(str){
  return str
        .replace(/(\w+)\(/g, &#39;$1 = function $1(&#39;)
        .replace(/\)(.+?)\n/g, &#39;){ return $1 }\n&#39;)
        .replace(/::/g, &#39;exports.&#39;);
	};</code></pre>

<p>Next we have to &quot;register&quot; the extension to assign out compiler. As previously mentioned our compiler lives at <em>./modules/compiler/extended.js</em> so we are requiring it in.  Prior to node.js 0.3.0, we would pass the <code>compile()</code> method to <code>require.registerExtension()</code> which simply expects a function accepting a string, and returning a string of JavaScript.</p>

<pre class="prettyprint"><code>require.registerExtension(&#39;.ejs&#39;, require(&#39;./compiler/extended&#39;).compile);</code></pre>

<p>The new way to register an extension is to add a key to the require.extensions object with a function which specifies how to process the file.  For compatibility, we can use <code>require.extensions</code> and fallback to <code>require.registerExtension</code>.</p>

<pre class="prettyprint"><code>// modules/compiler.js
if(require.extensions) {
  require.extensions[&#39;.ejs&#39;] = function(module,filename){
    var content = require(&#39;fs&#39;).readFileSync(filename, &#39;utf8&#39;);
    var newContent = require(&#39;./compiler/extended&#39;).compile(content);
    module._compile(newContent, filename);
  };
} else {
  require.registerExtension(&#39;.ejs&#39;, require(&#39;./compiler/extended&#39;).compile);
}</code></pre>

<p>Now when we require our example, the &quot;.ejs&quot; extension is detected, and will pass the contents through our compiler, and everything works as expected.</p>

<pre class="prettyprint"><code>// modules/compiler.js
var example = require(&#39;./compiler/example&#39;);
console.dir(example)
console.log(example.min(2, 3));
console.log(example.max(10, 8));</code></pre>

<p>This should display the following output when run with <code>node ./src/modules/compiler.js</code> in a terminal:</p>

<pre class="prettyprint"><code>$ node compiler.js 
{ min: [Function: min], max: [Function: max] }
2
10</code></pre>

<h2 id="patterns">Patterns</h2>

<p>  ...</p>

<h2 id="best_Practices">Best Practices</h2>

<p>  ...</p>

<h1>Addons</h1>

<p>The node documentation for addons is self-admittedly pretty weak as of v0.4.0.</p>

<p>This chapter doesn&#39;t aim to be a replacement for the official documentation.  Instead, we&#39;d hope this can expand on some of the basics a little more than a simple &quot;Hello, World!&quot; and drive you as a developer more on the path toward mastering node through its source code.</p>

<p>In fact, for now, we&#39;re only going to cover some shortcuts for creating properties on an object, functions, and interacting with function prototypes.  This doesn&#39;t reach the evented level of node&#39;s awesomeness, but you should be able to look at examples in node&#39;s source and the documention for <em>libev</em> and <em>libeio</em> to find answers.</p>

<h2 id="pre_requisites">Pre-requisites</h2>

<ul><li>Some C/C++ knowledge</li><li>V8 JavaScript</li><li>Internal Node libraries</li><li><a href="http://cvs.schmorp.de/libev/ev.html">libev</a></li><li>libeio</li></ul>

<h2 id="hello.node">hello.node</h2>

<p>Our first example is the very same one from node&#39;s docs.  We&#39;re going to include it for those who haven&#39;t read through the docs and have instead trusted in the knowledge of this ebook&#39;s authors (thanks, by the way).</p>

<p>A node addon begins with a source file containing a single entry point: </p>

<pre class="prettyprint"><code>// addons/hello/hello.cc
#include &lt;v8.h&gt;

using namespace v8;

extern &quot;C&quot; void
init (Handle&lt;Object&gt; target)
{
  HandleScope scope;
  target-&gt;Set(String::New(&quot;hello&quot;), String::New(&quot;world&quot;));
}</code></pre>

<p>This is a C/C++ file which begins by including the <em>v8.h</em> header.  It then uses the <em>v8</em> namespace to make the code a little cleaner. Finally, the entry point accepts a single parameter, <code>Handle&lt;Object&gt; target</code>.  If you don&#39;t use the <em>v8</em> namespace as we&#39;ve done here, your parameter will read <code>v8::Handle&lt;v8::Object&gt; target</code>.  As you can see, <code>Object</code> is a <em>v8</em> class.  This is actually the same object we would otherwise refer to using <code>exports</code> in a regular node source file.</p>

<p>Within the <code>init</code> method, we do two things.  First, we create a scope.  Again, this is the same as is done with the <code>exports</code> object in a JavaScript file.  Then we set a property on the <code>target</code> called <code>hello</code> which returns the string &quot;world&quot;.</p>

<p>If you were to perform the same actions as this source file (ignoring the scope part) in a node REPL console, it would look like:</p>

<pre class="prettyprint"><code>$ node
&gt; var target = {};
&gt; target.hello = &quot;world&quot;;
&#39;world&#39;</code></pre>

<h3 id="building_hello.node">Building hello.node</h3>

<p>Building a node addon requires <a href="http://code.google.com/p/waf">WAF</a>.  <em>node-waf</em>  should be installed if you&#39;ve installed node.js from source or distro. </p>

<pre class="prettyprint"><code>// addons/hello/wscript
srcdir = &#39;.&#39;
blddir = &#39;build&#39;
VERSION = &#39;0.0.1&#39;

def set_options(opt):
  opt.tool_options(&#39;compiler_cxx&#39;)

def configure(conf):
  conf.check_tool(&#39;compiler_cxx&#39;)
  conf.check_tool(&#39;node_addon&#39;)

def build(bld):
  obj = bld.new_task_gen(&#39;cxx&#39;, &#39;shlib&#39;, &#39;node_addon&#39;)
  obj.target = &#39;hello&#39;
  obj.source = &#39;hello.cc&#39;</code></pre>

<p>This file is relatively simple, there are two tasks: <em>configure</em> and <em>build</em>.  To run this script:</p>

<pre class="prettyprint"><code>$ cd src/addons/hello/wscript &amp;&amp; node-waf configure build</code></pre>

<p>Notice how you have to run node-waf from the directory of the <code>wscript</code> build script. Afterward, your built addon will be located at <em>./build/default/hello.node</em>.  You can load and play with the addon when you&#39;re finished.</p>

<pre class="prettyprint"><code>$ cd build/default &amp;&amp; node
&gt; var hello = require(&#39;./hello.node&#39;);
&gt; hello
{ hello: &#39;world&#39; }
&gt; </code></pre>

<h2 id="basic_Functions">Basic Functions</h2>

<p>The world of functions begins with an object that will resemble the following object:</p>

<pre class="prettyprint"><code>{ version: &#39;0.1&#39;, echo: [Function] }</code></pre>

<p>As you can imagine, node is already coding functions in the same way as you would for an addon.  Luckily, <em>node.h</em> provides a helper definition for setting a function to a callback, or method defined within your source file.  If you open <em>node.h</em> and look at line 33, you&#39;ll see:</p>

<pre class="prettyprint"><code>// [node repo]/src/node.h
#define NODE\_SET\_METHOD(obj, name, callback)                              \
  obj-&gt;Set(v8::String::NewSymbol(name),                                   \
           v8::FunctionTemplate::New(callback)-&gt;GetFunction())</code></pre>

<p>Let&#39;s reuse this bit of code.  One thing to note here is that since node is already defining how to set a method on a target object, changes to this functionality in v8 will most likely be reflected in this macro.  Because the addon compilation process links node anyway, including the header here shouldn&#39;t be an issue.  Plus, reusing the macro ensures that we&#39;re creating functions in the same way as the rest of the framework.</p>

<p>The following example will compile our desired object mentioned earlier.</p>

<pre class="prettyprint"><code>// addons/functions/v0.1/func.cc
#include &lt;v8.h&gt;
#include &lt;node.h&gt;

using namespace v8;  

static Handle&lt;Value&gt; Echo(const Arguments&amp; args) {
  HandleScope scope;

  if (args.Length() &lt; 1) {
    return ThrowException(Exception::TypeError(String::New(&quot;Bad argument&quot;)));
  }
  return scope.Close(args[0]);
}

extern &quot;C&quot; void
init (Handle&lt;Object&gt; target)
{
    HandleScope scope;

    target-&gt;Set(String::New(&quot;version&quot;), String::New(&quot;0.1&quot;));

    NODE_SET_METHOD(target, &quot;echo&quot;, Echo);
}</code></pre>

<p>This example differs in a couple of ways from the <em>Hello, World!</em> example.  First, it includes the <em>node.h</em> header containing the <code>NODE_SET_METHOD</code> macro.  Second, this contains a callback which is providing the functionality of our function.</p>

<p>Just as you would expect in a JavaScript function, the entrance and exit points of the function define a <code>scope</code> in which the <em>context</em> of the function executes (i.e. &#39;this&#39;).  Our function will throw an error if it doesn&#39;t receive the proper number of arguments, then returns the first argument regardless of how many others are passed.</p>

<p>The <em>WAF</em> script used to build this file is nearly identical to the one used for the <em>Hello, World!</em> example.  </p>

<p>Now, build the source and toy with it.  Here&#39;s a dump of my console, run from <em>./src/addons/functions/v0.1</em>. </p>

<pre class="prettyprint"><code>$ node-waf configure build &amp;&amp; cd build/default &amp;&amp; node
Checking for program g++ or c++          : /usr/bin/g++ 
Checking for program cpp                 : /usr/bin/cpp 
Checking for program ar                  : /usr/bin/ar 
Checking for program ranlib              : /usr/bin/ranlib 
Checking for g++                         : ok  
Checking for node path                   : ok /home/jim/.node_libraries 
Checking for node prefix                 : ok /usr/local 
&#39;configure&#39; finished successfully (0.164s)
Waf: Entering directory `/media/16GB/projects/masteringnode/src/addons/functions/v0.1/build&#39;
[1/2] cxx: func.cc -&gt; build/default/func_1.o
Waf: Leaving directory `/media/16GB/projects/masteringnode/src/addons/functions/v0.1/build&#39;
&#39;build&#39; finished successfully (0.587s)
&gt; var func = require(&#39;./func&#39;);
&gt; func
{ version: &#39;0.1&#39;, echo: [Function] }
&gt; func.echo
[Function]
&gt; func.echo()
TypeError: Bad argument
    at [object Context]:1:6
    at Interface.&lt;anonymous&gt; (repl.js:144:22)
    at Interface.emit (events.js:42:17)
    at Interface._onLine (readline.js:132:10)
    at Interface._line (readline.js:387:8)
    at Interface._ttyWrite (readline.js:564:14)
    at ReadStream.&lt;anonymous&gt; (readline.js:52:12)
    at ReadStream.emit (events.js:59:20)
    at ReadStream._emitKey (tty_posix.js:280:10)
    at ReadStream.onData (tty_posix.js:43:12)
&gt; func.echo(1)
1
&gt; func.echo(&quot;asdf&quot;, 20)
&#39;asdf&#39;
&gt; func.echo(function() { return 1; }, 222)
[Function]
&gt; func.echo(function() { return 1; }, 222)()
1</code></pre>

<p>Notice the construct of the last line is <code>func.echo()()</code>, which executes the function that is passed as the first argument.</p>

<h2 id="functionTemplate">FunctionTemplate</h2>

<p>In v8, a FunctionTemplate is used to create the equivalent to:</p>

<pre class="prettyprint"><code>var template = function() { }</code></pre>

<p>The function at this point is an object and not an <em>instance</em> of the function. </p>

<p>As an example, we will use the linux package <em>uuid</em> to generate a uuid. We will define the header for this addon as:</p>

<pre class="prettyprint"><code>// addons/uuid/v0.1/uuid.h
#ifndef __node_uuid_h__
#define __node_uuid_h__

#include &lt;string&gt;
#include &lt;v8.h&gt;
#include &lt;node.h&gt;
#include &quot;uuid/uuid.h&quot;

using namespace v8;
using namespace node;

class Uuid : public node::ObjectWrap {
    public:
        Uuid() { }
        static Persistent&lt;FunctionTemplate&gt; constructor;
        static void Init(Handle&lt;Object&gt; target);
        static Handle&lt;Value&gt; New(const Arguments &amp;args);
        static Handle&lt;Value&gt; Generate(const Arguments &amp;args);
        static Handle&lt;Value&gt; GenerateRandom(const Arguments &amp;args);
        static Handle&lt;Value&gt; GenerateTime(const Arguments &amp;args);
    private:   
        ~Uuid();
        static std::string GetString(uuid_t id);
};

#endif // __node_uuid_h__</code></pre>

<p>This addon will showcase three methods, <code>Generate</code>, <code>GenerateRandom</code>, and <code>GenerateTime</code>. It will also include a trivial private <code>GetString</code> method to demonstrate how to <em>Unwrap</em> a <code>node::ObjectWrap</code> object and interact with C++ code that is not specific to node or v8.</p>

<p>A lot of the public function definitions should look similar to the <em>Echo</em> example. One notable difference is that instead of using a macro and hiding the <code>FunctionTemplate</code> method, we are defining <code>static Persistent&lt;FunctionTemplate&gt; constructor;</code>.  The <code>Persistent&lt;T&gt;</code> type is used &quot;when you need to keep a reference to an object for more than one function call, or when handle lifetimes do not correspond to C++ scopes.&quot; <a href="http://code.google.com/apis/v8/embed.html">source</a>.  Since we&#39;d expect our object&#39;s constructor to last longer than a single function, we declare it separately and as a persistent handle.  Another point to notice is that all of the method we&#39;re pulling from <em>uuid.h</em> have the signature <code>static Handle&lt;Value&gt; Method(const Arguments &amp;args)</code> even though we will plan to call it as <code>uuid.generate()</code>.  This is because we will be accessing the <em>scope</em> of the call via <code>args.This()</code>.</p>

<p>Although more methods are implemented in <em>uuid.cc</em>, we will look at three:  </p>

<ul><li><code>Uuid::Init(Handle&lt;Object&gt; target)</code></li><li><code>Handle&lt;Value&gt; Uuid::New(const Arguments &amp;args)</code></li><li><code>Handle&lt;Value&gt; Uuid::Generate(const Arguments &amp;args)</code></li></ul>

<p>Just as before, node expects to find a signature of <code>extern &quot;C&quot; void init(Handle&lt;Object&gt; target)</code> in order to initialize the addon.  Inside this method, we may set parameters such as the version number from the previous example.  We may also pass-through initialization to any modules within our node addon.  In this example, our addon will be <em>uuid.node</em> and contain a single module, <em>Uuid</em>. There is no reason we can&#39;t later add <em>Uuid2</em> which, instead of returning a normalized string value might return a <code>Buffer</code> object.  To initialize the Uuid module, we pass the <code>target</code> object along to <code>Uuid::Init</code> and add the module definition to <code>target</code>:</p>

<pre class="prettyprint"><code>// addons/uuid/v0.1/uuid.cc
void Uuid::Init(Handle&lt;Object&gt; target) {
    HandleScope scope;

    // Setup the constructor
    constructor = Persistent&lt;FunctionTemplate&gt;::New(FunctionTemplate::New(Uuid::New));
    constructor-&gt;InstanceTemplate()-&gt;SetInternalFieldCount(1); // for constructors
    constructor-&gt;SetClassName(String::NewSymbol(&quot;Uuid&quot;));

    // Setup the prototype
    NODE_SET_PROTOTYPE_METHOD(constructor, &quot;generate&quot;, Generate);
    NODE_SET_PROTOTYPE_METHOD(constructor, &quot;generateRandom&quot;, GenerateRandom);
    NODE_SET_PROTOTYPE_METHOD(constructor, &quot;generateTime&quot;, GenerateTime);

    target-&gt;Set(String::NewSymbol(&quot;Uuid&quot;), constructor-&gt;GetFunction());
}</code></pre>

<p>In this scope, we are instantiating the <code>constructor</code> using <code>Uuid::New</code> as a new <code>FunctionTemplate</code>. We then call <code>InstanceTemplate()</code> and on that object we call <code>SetInternalFieldCount(1)</code>. This tells v8 that this object holds a reference to one object.</p>

<p>Next, we setup the prototype using another macro provided by node. These calls say, for instance, &quot;Add a method called <em>generate</em> to the constructor function which executes the native method <em>Generate</em>&quot;.</p>

<p>Lastly, we have to create a &quot;Uuid&quot; module on the object returned by the call to <code>require()</code>. Here, <code>Uuid</code> will point to a function (<code>constructor</code>) which returns a function that internally executes <code>Uuid::New</code>.  In other words, we have created something akin to: </p>

<pre class="prettyprint"><code>var Uuid = function() { };
Uuid.constructor = function() {
    return function() {
        // Uuid::New executes here.
    }
}</code></pre>

<p>Although the above is not exactly what we have done, it may provide a better view for some to understand <code>FunctionTemplate</code> references and why we assign one to the constructor object in such a way.</p>

<p>The <code>Uuid::New</code> method is defined as:</p>

<pre class="prettyprint"><code>// addons/uuid/v0.1/uuid.cc
Handle&lt;Value&gt; Uuid::New(const Arguments &amp;args) {
    HandleScope scope;
    // no args are checked
    Uuid *uuid = new Uuid();
    uuid-&gt;Wrap(args.This());
    return args.This();
}</code></pre>

<p>As you would expect, calling the constructor function multiple times will create newly-scoped <code>Uuid</code> objects on the heap. In this method, we <a href="https://github.com/joyent/node/blob/v0.4.8/src/node_object_wrap.h#L59">wrap</a> the parameter (scoped object) by setting a reference to <code>Uuid</code> in the args as a contextual scope (i.e. <code>this</code>) and then returns <code>this</code>.</p>

<p>Within the <code>Generate</code> method, we will want to unwrap the contextual <code>Uuid</code> object and call the private method <code>GetString</code>.</p>

<pre class="prettyprint"><code>// addons/uuid/v0.1/uuid.cc
Handle&lt;Value&gt; Uuid::Generate(const Arguments &amp;args) {
    HandleScope scope;
    uuid_t id;
    uuid_generate(id);

    Uuid *uuid = ObjectWrap::Unwrap&lt;Uuid&gt;(args.This());
    return scope.Close(String::New(uuid-&gt;GetString(id).c_str()));
}</code></pre>

<p>As with any JavaScript function call, we have to ensure <a href="https://developer.mozilla.org/en/JavaScript/Reference/Functions_and_function_scope">functional scope</a>. Scoped methods should create a <a href="http://code.google.com/apis/v8/embed.html">HandleScope</a> object at the start and call <code>scope.Close()</code> at the end. <code>HandleScope</code> will get rid of temporary handles when the scope is closed.</p>

<p>Within each of the <em>Generate*</em> methods, we will create a <code>uuid_t</code> type and call the corresponding method defined in <em>/usr/includes/uuid/uuid.h</em> (location may vary per system). To demonstrate accessing the pointer to our original <code>Uuid</code> object, we unwrap the contextual scope of this function using <code>ObjectWrap::Unwrap&lt;Uuid&gt;(args.This())</code>. From this pointer, we can access any private methods such as <code>GetString</code>. Be careful with your returned values, though. <code>String::New</code> in the v8 library does not take <code>std::string</code> in any of its signatures. Simply enough, <code>std::string</code> provides a <code>c_str()</code> method to return a <code>const char*</code> which <code>String::New</code> does accept.</p>

<h3 id="uuid.node_demo">uuid.node demo</h3>

<p>Navigate to <em>addons/uuid/v0.1/</em> and execute:</p>

<pre class="prettyprint"><code>$ node-waf configure build</code></pre>

<p>If there are build errors and the <em>func.cc</em> example from before built successfully, check that you have the <em>uuid-dev</em> package installed and rerun the above command. Then, navigate to <em>build/default</em> and try out the Uuid addon:</p>

<pre class="prettyprint"><code>$ node
&gt; var Uuid = require(&#39;./uuid.node&#39;).Uuid;
&gt; var uuid = new Uuid();
&gt; uuid.generate();
&#39;83475e0c-212b-402c-bdc7-b81ebb7b34f8&#39;
&gt; uuid.generateRandom();
&#39;4d597bda-8f5f-4c3c-b2fa-1cd6cd4a6903&#39;
&gt; uuid.generateTime();
&#39;25a0dd30-5076-11e1-96be-0022fb93b24c&#39;
&gt; var util = require(&#39;util&#39;);
&gt; util.inspect(uuid);
&#39;{}&#39;
&gt; util.inspect(Uuid);
&#39;[Function: Uuid]&#39;
&gt; </code></pre>

<p>The above output may surprise you. Firstly, where is the <code>version</code> option?! It&#39;s at the required module level: <code>require(&#39;./uuid.node&#39;).version;</code>. Secondly, if we can access <code>uuid.generate()</code> and others, why don&#39;t they display when inspecting the object? That&#39;s because we defined those methods on the prototype:</p>

<pre class="prettyprint"><code>&gt; uuid.__proto__
{ generate: [Function: generate],
  generateRandom: [Function: generateRandom],
  generateTime: [Function: generateTime] }
&gt; </code></pre>

<p>Thirdly, you may have noticed that I didn&#39;t say anything about <code>constructor-&gt;SetClassName(String::NewSymbol(&quot;Uuid&quot;));</code> in <code>Uuid::Init</code>. You may have also wondered where <code>SetClassName</code> actually sets a class name, considering JavaScript is a prototypal language. That string value is what is displayed when you call inspect and get the value <code>&#39;[Function: Uuid]&#39;</code>. Just as you would expect, <code>Uuid</code> is the constructor and it is named <code>Uuid</code>. </p>

<p>Now, if you&#39;ve played around with this a bit, you may have noticed that <code>uuid.__proto__</code> gives us our three functions but <code>uuid.prototype</code> is empty. Why is that? That&#39;s because <code>uuid.__proto__</code> really is <code>uuid.constructor.prototype</code>, which is also really <code>Uuid.prototype</code>. This is the essence of prototypal inheritance. If this concept is foreign or difficult to grasp, be sure to check out the excellent explanation on <a href="http://bonsaiden.github.com/JavaScript-Garden/#object.prototype">JavaScript Garden</a>.</p>

<p>Logically, the next step would be to understand how to declare a prototype of our own.</p>

<h2 id="function_Prototypes">Function Prototypes</h2>

<p><em>TODO</em></p>

<h2 id="function_Constructor">Function Constructor</h2>

<p><em>TODO</em></p>

<h2 id="making_it_Evented">Making it Evented</h2>

<p><em>TODO</em></p>

<h1>Globals</h1>

<p> As we have learned, node&#39;s module system discourages the use of globals. However, node provides a few important globals for us. The first, and probably the most important, is the <code>process</code> global which exposes process manipulation (e.g. signalling, exiting, process id (pid), and others). Other globals, such as the <code>console</code> object, provide JavaScript functionality common in most browsers.</p>

<h2 id="console">console</h2>

<p>The <code>console</code> object contains several methods which are used to output information to <em>stdout</em> or <em>stderr</em>. </p>

<pre class="prettyprint"><code>&gt; console
{ log: [Function],
  info: [Function],
  warn: [Function],
  error: [Function],
  dir: [Function],
  time: [Function],
  timeEnd: [Function],
  trace: [Function],
  assert: [Function] }</code></pre>

<p>Let&#39;s take a look at what each method does.</p>

<h3 id="console.log">console.log()</h3>

<p>The most frequently used console method is <code>console.log()</code>, simply writing to <em>stdout</em> with a line feed (<code>\n</code>). Currently aliased as <code>console.info()</code>.</p>

<pre class="prettyprint"><code>&gt; console.log(&#39;wahoo&#39;);
wahoo

&gt; console.log({ foo: &#39;bar&#39; });
{ foo: &#39;bar&#39; }</code></pre>

<h3 id="console.error">console.error()</h3>

<p>Identical to <code>console.log()</code>, however writes to <em>stderr</em>. Aliased as <code>console.warn()</code> as well.</p>

<pre class="prettyprint"><code>console.error(&#39;database connection failed&#39;);</code></pre>

<h3 id="console.dir">console.dir()</h3>

<p>Utilizes the <em>sys</em> module&#39;s <code>inspect()</code> method to pretty-print the object to
<em>stdout</em>.</p>

<pre class="prettyprint"><code>&gt; console.dir({ foo: &#39;bar&#39; });
{ foo: &#39;bar&#39; } </code></pre>

<h3 id="console.assert">console.assert()</h3>

<p>Asserts that the given expression is truthy, or throws an exception.  Here, you can also use <code>console.trace()</code> and <code>console.error()</code> to print a stack trace and a helpful message when the exception is caught.</p>

<pre class="prettyprint"><code>try {
   console.assert( (1 != 2), &#39;1 != 2: Should be true&#39; );
   console.assert( (1 == 2), &#39;1 == 2: Should be false&#39;);
} catch(e) {
   console.error(&#39;Caught error &#39; + e);
   console.trace();
}</code></pre>

<h2 id="process">process</h2>

<p>The <code>process</code> object is plastered with goodies. In a node console, type <code>process</code> and look at what it has to offer. First we will take a look
at some properties that provide information about the node process itself.</p>

<h3 id="process.version">process.version(s)</h3>

<p>The <code>process.version</code> property contains the node version string, for example &quot;v0.4.0&quot;.  The <code>process.versions</code> object displays the versions of node, v8, ares, ev, and openssl:</p>

<pre class="prettyprint"><code>&gt; process.versions
{ node: &#39;0.4.0&#39;,
  v8: &#39;3.1.2&#39;,
  ares: &#39;1.7.4&#39;,
  ev: &#39;4.3&#39;,
  openssl: &#39;0.9.8o&#39; }</code></pre>

<h3 id="process.installPrefix">process.installPrefix</h3>

<p>Exposes the installation prefix, which defaults to &quot;<em>/usr/local</em>&quot;, as node&#39;s binary was installed to &quot;<em>/usr/local/bin/node</em>&quot;.</p>

<h3 id="process.execPath">process.execPath</h3>

<p>Path to the executable itself, defaults to &quot;<em>/usr/local/bin/node</em>&quot;.</p>

<h3 id="process.platform">process.platform</h3>

<p>Exposes a string indicating the platform you are running on, for example &quot;darwin&quot; or &quot;linux&quot;.</p>

<h3 id="process.pid">process.pid</h3>

<p>The process id.</p>

<h3 id="process.cwd">process.cwd()</h3>

<p>Returns the current working directory, for example:</p>

<pre class="prettyprint"><code>$ cd /var &amp;&amp; node
&gt; process.cwd()
&#39;/var&#39;</code></pre>

<h3 id="process.chdir">process.chdir()</h3>

<p>Changes the current working directory to the path passed.</p>

<pre class="prettyprint"><code>&gt; process.chdir(&#39;lib&#39;)
&gt; process.cwd()
&#39;/var/lib&#39;</code></pre>

<h3 id="process.getuid">process.getuid()</h3>

<p>Returns the numerical user id of the running process.</p>

<h3 id="process.setuid">process.setuid()</h3>

<p>Sets the effective user id for the running process. This method accepts both a numerical id, as well as a string. For example both <code>process.setuid(501)</code>, and <code>process.setuid(&#39;tj&#39;)</code> are valid, where 501 is TJ&#39;s <em>uid</em>.</p>

<h3 id="process.getgid">process.getgid()</h3>

<p>Returns the numerical group id of the running process.</p>

<h3 id="process.setgid">process.setgid()</h3>

<p>Similar to <code>process.setuid()</code> however operates on the group, also accepting a numerical value or string representation. For example <code>process.setgid(20)</code> or <code>process.setgid(&#39;www&#39;)</code>.</p>

<h3 id="process.env">process.env</h3>

<p>An object containing the user&#39;s environment variables, for example:</p>

<pre class="prettyprint"><code>{ PATH: &#39;/Users/tj/.gem/ruby/1.8/bin:/Users/tj/.nvm/current/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/usr/X11/bin&#39;
, PWD: &#39;/Users/tj/ebooks/masteringnode&#39;
, EDITOR: &#39;mate&#39;
, LANG: &#39;en_CA.UTF-8&#39;
, SHLVL: &#39;1&#39;
, HOME: &#39;/Users/tj&#39;
, LOGNAME: &#39;tj&#39;
, DISPLAY: &#39;/tmp/launch-YCkT03/org.x:0&#39;
, _: &#39;/usr/local/bin/node&#39;
, OLDPWD: &#39;/Users/tj&#39;
}</code></pre>

<h3 id="process.argv">process.argv</h3>

<p>When executing a file with the <code>node</code> executable, <code>process.argv</code> provides access to the argument vector, the first value being the node executable, second being the filename, and remaining values being the arguments passed.</p>

<p>For example, our source file <em>./src/process/misc.js</em> can be executed by running:</p>

<pre class="prettyprint"><code>$ node src/process/misc.js foo bar baz</code></pre>

<p>in which we call <code>console.dir(process.argv)</code>, outputting the following:</p>

<pre class="prettyprint"><code>[ &#39;node&#39;
, &#39;/Users/tj/EBooks/masteringnode/src/process/misc.js&#39;
, &#39;foo&#39;
, &#39;bar&#39;
, &#39;baz&#39;
]</code></pre>

<h3 id="process.exit">process.exit()</h3>

<p>The <code>process.exit()</code> method is synonymous with the C function <code>exit()</code>, in which a exit code &gt; 0 is passed indicating failure, or 0 to indicate success. When invoked the <em>exit</em> event is emitted, allowing a short time for arbitrary processing to occur before <code>process.reallyExit()</code> is called with the given status code.</p>

<h3 id="process.on">process.on()</h3>

<p>The process itself is an <code>EventEmitter</code>, allowing you to do things like listen for uncaught exceptions, via the <em>uncaughtException</em> event:</p>

<pre class="prettyprint"><code>// process/exceptions.js
process.on(&#39;uncaughtException&#39;, function(err){
    console.log(&#39;got an error: %s&#39;, err.message);
    process.exit(1);
});

setTimeout(function(){
    throw new Error(&#39;fail&#39;);
}, 100);</code></pre>

<h3 id="process.kill">process.kill()</h3>

<p><code>process.kill()</code> method sends the signal passed to the given <em>pid</em>, defaulting to <strong>SIGINT</strong>. In our example below we send the <strong>SIGTERM</strong> signal to the same node process to illustrate signal trapping, after which we output &quot;terminating&quot; and exit. Note that our second timeout of 1000 milliseconds is never reached.</p>

<pre class="prettyprint"><code>// process/kill.js
process.on(&#39;SIGTERM&#39;, function(){
    console.log(&#39;terminating&#39;);
    process.exit(1);
});

setTimeout(function(){
    console.log(&#39;sending SIGTERM to process %d&#39;, process.pid);
    process.kill(process.pid, &#39;SIGTERM&#39;);
}, 500);

setTimeout(function(){
    console.log(&#39;never called&#39;);
}, 1000);</code></pre>

<h3 id="process.binding">process.binding()</h3>

<p>Node performs lazy initialization and caching for a number of built-in modules through the <code>process.binding</code> function.  If you&#39;d like to poke around in node&#39;s source code and view this binding cache implementation, navigate to your node checkout directory and open <em>./src/node.cc</em>.  The code for the binding cache starts on like 1749 (of node.js v0.4.0).</p>

<p>Currently, the cacheable process bindings include: built-in modules, <code>constants</code>, <code>io_watcher</code>, <code>timer</code> and <code>natives</code>.  To access the constants, instead of using <code>var constants = require(&#39;constants&#39;);</code>, you could lazily bind the constants as it is done in the <code>fs</code> module:</p>

<pre class="prettyprint"><code>// [node.js source]/lib/fs.js
var util = require(&#39;util&#39;);

var binding = process.binding(&#39;fs&#39;);
var constants = process.binding(&#39;constants&#39;);
var fs = exports;
var Stream = require(&#39;stream&#39;).Stream;
// ...</code></pre>

<p>Binding in this way allows us to perform the initialization of those modules bound to <code>process</code> only once. We can then extend those bindings because they are an exported module like any other <code>require</code>.</p>

<p>Another reason for caching the bindings in this way is because these bindings differ across platforms.  If you were to open <em>node</em>constants.cc<em>, you would see conditional includes for </em>MINGW32<em> and <code>ifdef</code>s for each constant.  You wouldn&#39;t want to hardcode these constants in a module&#39;s exports.  If you opened opened the </em>constants_ module definition, you would see one line:</p>

<pre class="prettyprint"><code>// [node.js source]/lib/constants.js
module.exports = process.binding(&#39;constants&#39;);</code></pre>

<p>After a single require of this module, or call to <code>process.binding(&#39;constants&#39;)</code>, the constants are initialized and cached.  This lazy initialization improves node&#39;s startup.</p>

<h3 id="errno">errno</h3>

<p>To access <code>errno</code> constants, you&#39;ll need to either add the include <code>var constants = require(&#39;constants&#39;);</code> or use the <code>var constants = process.binding(&#39;constants&#39;);</code> method described earlier.</p>

<p>The <code>constants</code> object is host of the error numbers, these reference what you would find in C-land, for example <code>constants.EPERM</code> represents a permission based error, while <code>constants.ENOENT</code> represents a missing file or directory. Typically these are used within bindings to bridge the gap between C++ and JavaScript, however useful for handling exceptions as well as in the http request error object:</p>

<pre class="prettyprint"><code>if (err.errno === constants.ENOENT) {
	// Display a 404 &quot;Not Found&quot; page
} else {
	// Display a 500 &quot;Internal Server Error&quot; page
}</code></pre>

<h1>Events</h1>

<p> The concept of an &quot;event&quot; is crucial to node, and used greatly throughout core and 3rd-party modules. Node&#39;s core module <em>events</em> supplies us with a single constructor, <code>EventEmitter</code>.</p>

<h2 id="emitting_Events">Emitting Events</h2>

<p>Typically an object inherits from <code>EventEmitter</code>, however our small example below illustrates the api. First we create an <code>emitter</code>, after which we can define any number of callbacks using the <code>emitter.on()</code> method which accepts the <em>name</em> of the event, and arbitrary objects passed as data. When <code>emitter.emit()</code> is called we are only required to pass the event <em>name</em>, followed by any number of arguments, in this case the <code>first</code> and <code>last</code> name strings.</p>

<pre class="prettyprint"><code>// events/basic.js
var EventEmitter = require(&#39;events&#39;).EventEmitter;

var emitter = new EventEmitter;

emitter.on(&#39;name&#39;, function(first, last){
    console.log(first + &#39;, &#39; + last);
});

emitter.emit(&#39;name&#39;, &#39;tj&#39;, &#39;holowaychuk&#39;);
emitter.emit(&#39;name&#39;, &#39;simon&#39;, &#39;holowaychuk&#39;);</code></pre>

<h2 id="inheriting_From_EventEmitter">Inheriting From EventEmitter</h2>

<p>Perhaps a more practical use of <code>EventEmitter</code>, and commonly used throughout node, is to inherit from it. This means we can leave <code>EventEmitter</code>&#39;s prototype untouched, while utilizing its api for our own means of world domination!</p>

<p>To do so we begin by defining the <code>Dog</code> constructor, which of course will bark from time to time, also known as an <em>event</em>.</p>

<pre class="prettyprint"><code>// events/subclass.js
var EventEmitter = require(&#39;events&#39;).EventEmitter;

function Dog(name) {
    this.name = name;
}</code></pre>

<ul><li>Note: JavaScript doesn&#39;t have &#39;classes&#39;.  The file above is called &#39;subclass&#39; because this is a term commonly used for inheritance in an object-oriented language.*</li></ul>

<p>Here we inherit from <code>EventEmitter</code>, so that we may use the methods provided such as <code>EventEmitter#on()</code> and <code>EventEmitter#emit()</code>. If the <code>__proto__</code> property is throwing you off, no worries! we will be touching on this later.</p>

<pre class="prettyprint"><code>Dog.prototype.__proto__ = EventEmitter.prototype;</code></pre>

<p>Now that we have our <code>Dog</code> set up, we can create .... simon! When simon barks we can let <em>stdout</em> know by calling <code>console.log()</code> within the callback. The callback it-self is called in context to the object, aka <code>this</code>.</p>

<pre class="prettyprint"><code>var simon = new Dog(&#39;simon&#39;);

simon.on(&#39;bark&#39;, function(){
    console.log(this.name + &#39; barked&#39;);
});</code></pre>

<p>Bark twice a second:</p>

<pre class="prettyprint"><code>setInterval(function(){
    simon.emit(&#39;bark&#39;);
}, 500);</code></pre>

<p>You may look at the above code and think, &quot;Why don&#39;t I just add a <em>bark</em> function?&quot;  That&#39;s a good question.  The power of events is in subscribing to events that occur when a function on the object is executed.  For instance, if you have a writeable <code>Stream</code> object with the function <code>write()</code>, you may subscribe to a data event.  The following event example is directly from the node api documentation:</p>

<pre class="prettyprint"><code>// events/streams.js
var util = require(&quot;util&quot;);
var events = require(&quot;events&quot;);

function MyStream() {
    events.EventEmitter.call(this);
}

util.inherits(MyStream, events.EventEmitter);

MyStream.prototype.write = function(data) {
    this.emit(&quot;data&quot;, data);
}

var stream = new MyStream();

console.log(stream instanceof events.EventEmitter); // true
console.log(MyStream.super_ === events.EventEmitter); // true

stream.on(&quot;data&quot;, function(data) {
	console.log(&#39;Received data: &quot;&#39; + data + &#39;&quot;&#39;);
});
stream.write(&quot;It works!&quot;); // Received data: &quot;It works!&quot;</code></pre>

<p>This example is fairly complicated compared to most of the examples so far.  It does a number of things that haven&#39;t yet been covered, but are included here for completeness.  First of all, we&#39;re creating an object of <code>MyStream</code> called <code>stream</code>, which inherits from <code>EventEmitter</code>. This was mentioned earlier, but the api&#39;s example provides a nice use of the util module for inheritance.  Then, we set the <code>write</code> function to emit the <em>data</em> event to any subscribers (which are called <em>EventListeners</em>).  In this function, we could also provide some default functionality (more than emitting an event), such as writing to an inner sink, logging, or any number of operations.</p>

<p>After setting up the object, this example writes to <code>console.log()</code> to demonstrate that both the stream and the <code>super_</code> object are instances of <code>EventEmitter</code>.  Afterward, we subscribe to the <code>&quot;data&quot;</code> event and log the data that is emitted from the <code>MyStream.prototype.write</code> function.  This means that anything passed to the <code>write()</code> function is emitted to all subscribers as the single object passed to the callback function.  In other words, anytime we call <code>write()</code>, we&#39;re going to log with a little message to show that the parameter is being written by the emitted event.</p>

<p>So, unlike the dog barking example, this shows that a single function can have multiple operations occur via events.</p>

<p><strong>Note: when adding an event, it is pushed onto the end of an array of existing events</strong> </p>

<h2 id="removing_Event_Listeners">Removing Event Listeners</h2>

<p>As we have seen, event listeners are simply functions which are called when we <code>emit()</code> an event. Although not seen often, we can remove these listeners by calling the <code>removeListener(type, callback)</code> method. In the example below, we emit the <em>message</em> <code>&#39;foo bar&#39;</code> every <code>300</code> milliseconds, which has the callback of <code>console.log()</code>. After 1000 milliseconds we call <code>removeListener()</code> with the same arguments that we passed to <code>emitter.on()</code> originally. To complement this method is <code>removeAllListeners(type)</code>, which removes all listeners associated to the given <em>type</em>.</p>

<pre class="prettyprint"><code>// events/removing.js
var EventEmitter = require(&#39;events&#39;).EventEmitter;

var emitter = new EventEmitter;

emitter.on(&#39;message&#39;, console.log);

setInterval(function(){
    emitter.emit(&#39;message&#39;, &#39;foo bar&#39;);
}, 300);

setTimeout(function(){
    emitter.removeListener(&#39;message&#39;, console.log);
}, 1000);</code></pre>

<h1>Buffers</h1>

<p>To handle binary data, node provides us with the global <code>Buffer</code> object. Buffer instances represent memory allocated independently to that of V8&#39;s heap. There are several ways to construct a <code>Buffer</code> instance, and many ways you can manipulate it&#39;s data.</p>

<p>The simplest way to construct a <code>Buffer</code> from a string is to pass a string as the first argument to <code>Buffer</code>&#39;s constructor. As you can see by the log output, we now have a buffer object containing 5 bytes of data represented in hexadecimal.</p>

<pre class="prettyprint"><code>&gt; var hello = new Buffer(&#39;Hello&#39;);

&gt; console.log(hello);
&lt;Buffer 48 65 6c 6c 6f&gt;

&gt; console.log(hello.toString());
&#39;Hello&#39;</code></pre>

<p>By default the encoding is &quot;utf8&quot;, however this can be specified by passing as string as the second argument. The ellipsis below for example will be printed to stdout as the &#39;&amp;&#39; character when in &quot;ascii&quot; encoding.</p>

<pre class="prettyprint"><code>&gt; var buf = new Buffer(&#39;…&#39;);
&gt; console.log(buf.toString());
&#39;…&#39;

&gt; var buf = new Buffer(&#39;…&#39;, &#39;ascii&#39;);
&gt; console.log(buf.toString());
&#39;&amp;&#39;</code></pre>

<p>An alternative method is to pass an array of integers representing the octet stream.</p>

<pre class="prettyprint"><code>&gt; var h = [0x48, 0x65, 0x6c, 0x6c, 0x6f];
&gt; h
[ 72, 101, 108, 108, 111 ]

&gt; h.toString();
&#39;72,101,108,108,111&#39;

&gt; var hello = new Buffer(h);
&lt;Buffer 48 65 6c 6c 6f&gt;

&gt; hello.toString();
&#39;Hello&#39;</code></pre>

<p>Buffers can also be created with an integer representing the number of bytes allocated, after which we may call the <code>write()</code> method, providing an optional offset and encoding. As shown below, we create a buffer large enough to hold the string &quot;Hello World!&quot;  After writing &#39;Hello&#39;, we see the bytes 5 through 12 are unused bytes.  We then write &#39; World&#39; starting at byte 6 and examine the output.  Whoops!  We skipped a byte.  We can overwrite this part of the buffer with &#39; World!&#39; starting at byte 5.  We then call <code>toString()</code> on the buffer and see that the buffer is now filled with the desired string.</p>

<pre class="prettyprint"><code>&gt; var hello = new Buffer(12);
&gt; hello.write(&#39;Hello&#39;);
5

&gt; hello.toString();
&#39;Hello\u0000�̵\u0001\u0000\u0000&#39;
&gt; hello.write(&#39; World&#39;, 6);
6

&gt; hello.toString();
&#39;Hello\u0000 World&#39;

&gt; hello.write(&#39; World!&#39;, 5);
7

&gt; hello.toString();
&#39;Hello World!&#39;

&gt; hello.length
12</code></pre>

<p>The <code>length</code> property of a buffer instance contains the byte length of the stream, opposed to JavaScript strings which will simply return the number of characters. For example the ellipsis character &#39;…&#39; consists of three bytes, however the buffer will respond with the byte length, and not the character length.</p>

<pre class="prettyprint"><code>&gt; var ellipsis = new Buffer(&#39;…&#39;, &#39;utf8&#39;);
&gt; console.log(&#39;… string length: %d&#39;, &#39;…&#39;.length);
… string length: 1

&gt; console.log(&#39;… byte length: %d&#39;, ellipsis.length);
… byte length: 3

&gt; ellipsis
&lt;Buffer e2 80 a6&gt;</code></pre>

<p>When dealing with a JavaScript string, we may pass it to the <code>Buffer.byteLength()</code> method to determine it&#39;s byte length.</p>

<pre class="prettyprint"><code>&gt; Buffer.byteLength(&#39;…&#39;);
3</code></pre>

<p>The api is written in such a way that it is String-like, so for example we can work with &quot;slices&quot; of a <code>Buffer</code> by passing offsets to the <code>slice()</code> method:</p>

<pre class="prettyprint"><code>&gt; var buf = new Buffer(&#39;For some other string!&#39;);
&gt; var chunk = buf.slice(4, 8);
&gt; console.log(chunk.toString());
&#39;some&#39;</code></pre>

<p>Alternatively when expecting a string we can pass offsets to <code>Buffer#toString()</code>:</p>

<pre class="prettyprint"><code>&gt; var buffer = new Buffer(&#39;The quick brown fox&#39;);
&gt; buffer.toString(&#39;ascii&#39;, 4, 9);
&#39;quick&#39;</code></pre>

<p>A Buffer object has a number of helper functions: <code>.utf8Write()</code>, <code>.utf8Slice()</code>, <code>.asciiWrite()</code>, <code>.asciiSlice()</code>, <code>.binaryWrite()</code>, <code>.binarySlice()</code>.  These methods provide similar functionality while enforcing proper encoding.</p>

<h1>Streams</h1>

<p>Streams are an important concept in node. The stream api is a unified way to handle stream-like data, for example data can be streamed to a file, streamed to a socket to respond to an HTTP request, or a stream can be read-only such as reading from <em>stdin</em>. However since we will be touching on stream specifics in later chapters, for now we will concentrate on the api.</p>

<h2 id="readable_Streams">Readable Streams</h2>

<p>Readable streams such as an HTTP request inherit from <code>EventEmitter</code> in order to expose incoming data through events. The first of these events is the <em>data</em> event, which is an arbitrary chunk of data passed to the event handler as a <code>Buffer</code> instance. </p>

<pre class="prettyprint"><code>req.on(&#39;data&#39;, function(buf){
    // Do something with the Buffer
});</code></pre>

<p>As we know, we can call <code>toString()</code> on a buffer to return a string representation of the binary data. In the case of streams, if desired, we may call <code>setEncoding()</code> on the stream, after which the <em>data</em> event will emit strings.</p>

<pre class="prettyprint"><code>req.setEncoding(&#39;utf8&#39;);
req.on(&#39;data&#39;, function(str){
    // Do something with the String
});</code></pre>

<p>Another important event is the <em>end</em> event, which represents the ending of <em>data</em> events. For example below we define an HTTP echo server, simply &quot;pumping&quot; the request body data through to the response. So if we <strong>POST</strong> &quot;hello world&quot;, our response will be &quot;hello world&quot;.</p>

<pre class="prettyprint"><code>// streams/echo.js
var http = require(&#39;http&#39;);

http.createServer(function(req, res){
    res.writeHead(200);
    req.on(&#39;data&#39;, function(data){
        res.write(data);
    });
    req.on(&#39;end&#39;, function(){
        res.end();
    });
}).listen(3000);</code></pre>

<p>The <em>sys</em> module actually has a function designed specifically for this &quot;pumping&quot; action, aptly named <code>sys.pump()</code>, which accepts a read stream as the first argument, and write stream as the second.</p>

<pre class="prettyprint"><code>// streams/pump.js
var http = require(&#39;http&#39;),
    sys = require(&#39;sys&#39;);

http.createServer(function(req, res){
    res.writeHead(200);
    sys.pump(req, res);
}).listen(3000);</code></pre>

<h1>File System</h1>

<p>  To work with the filesystem, node provides the &#39;fs&#39; module. The commands follow the POSIX operations, with most methods supporting an asynchronous and synchronous method call. We will look at how to use both and then establish which is the better option.</p>

<h2 id="working_with_the_filesystem">Working with the filesystem</h2>

<p>  Lets start with a basic example of working with the filesystem, this example creates a directory, it then creates a file in it. Once the file has been created the contents of the file are written to console:</p>

<pre class="prettyprint"><code>// fs/basics.js
var fs = require(&#39;fs&#39;);

fs.mkdir(&#39;./helloDir&#39;,0777, function (err) {
  if (err) throw err;

  fs.writeFile(&#39;./helloDir/message.txt&#39;, &#39;Hello Node&#39;, function (err) {
    if (err) throw err;
    console.log(&#39;file created with contents:&#39;);

    fs.readFile(&#39;./helloDir/message.txt&#39;,&#39;UTF-8&#39; ,function (err, data) {
      if (err) throw err;
      console.log(data);
    });
  });
});</code></pre>

<p>  As evident in the example above, each callback is placed in the previous callback - this is what is referred to as chainable callbacks. When using asynchronous methods this pattern should be used, as there is no guarantee that the operations will be completed in the order that they are created. This could lead to unpredictable behavior.</p>

<p>  The example can be rewritten to use a synchronous approach:</p>

<pre class="prettyprint"><code>fs.mkdirSync(&#39;./helloDirSync&#39;,0777);
fs.writeFileSync(&#39;./helloDirSync/message.txt&#39;, &#39;Hello Node&#39;);
var data = fs.readFileSync(&#39;./helloDirSync/message.txt&#39;,&#39;UTF-8&#39;);
console.log(&#39;file created with contents:&#39;);
console.log(data);</code></pre>

<p>  It is better to use the asynchronous approach on servers with a high load, as the synchronous methods will cause the whole process to halt and wait for the operation to complete. This will block any incoming connections and other events.</p>

<h2 id="file_information">File information</h2>

<p>The fs.Stats object contains information about a particular file or directory. This can be used to determine what type of object we are working with. In this example we are getting all the file objects in a directory and displaying whether they are a file or a directory object.</p>

<pre class="prettyprint"><code>// fs/stat.js
var fs = require(&#39;fs&#39;);

fs.readdir(&#39;/etc/&#39;, function (err, files) {
  if (err) throw err;

  files.forEach( function (file) {
    fs.stat(&#39;/etc/&#39; + file, function (err, stats) {
      if (err) throw err;

      if (stats.isFile()) {
        console.log(&quot;%s is file&quot;, file);
      }
      else if (stats.isDirectory ()) {
      console.log(&quot;%s is a directory&quot;, file);
      }    
    console.log(&#39;stats:  %s&#39;,JSON.stringify(stats));
    });
  });
});</code></pre>

<h2 id="watching_files">Watching files</h2>

<p>  The fs.watchfile monitors a file and will fire the event whenever the file is changed.</p>

<pre class="prettyprint"><code>// fs/watch.js
var fs = require(&#39;fs&#39;);

fs.watchFile(&#39;./testFile.txt&#39;, function (curr, prev) {
  console.log(&#39;the current mtime is: &#39; + curr.mtime);
  console.log(&#39;the previous mtime was: &#39; + prev.mtime);
});

fs.writeFile(&#39;./testFile.txt&#39;, &quot;changed&quot;, function (err) {
  if (err) throw err;

  console.log(&quot;file write complete&quot;);   
});</code></pre>

<p>  A file can also be unwatched using the fs.unwatchFile method call. This is used once monitoring of a file is no longer required.</p>

<h2 id="nodejs_Docs_for_further_reading">Nodejs Docs for further reading</h2>

<p>  The node api <a href="http://nodejs.org/api.html#file-system-106">docs</a> are very detailed and list all the possible filesystem commands available when working with Nodejs.</p>

<h1>Net (TCP)</h1>

<p>The <code>net</code> module handles lower-level networking than the <code>http</code> module. In fact, the <code>http</code> module uses the <code>net</code> module to create connections and <code>http.Server</code> even inherits <code>net.Server</code> while adding listeners (&#39;connect&#39;, &#39;request&#39;).</p>

<p>The <code>net</code> module was previously (pre- 0.2.0) called the <code>tcp</code> module.  The module was most likely renamed to create a logical API similar to other APIs.</p>

<p>What the <code>net</code> module really accomplishes is opening <code>sockets</code> for bi-directional communication.  These sockets can either be network-based (TCP/IP) or process-based.  Network-based sockets refer to addresses in the form <em>ip:port</em>, which you are probably very familiar with at this point.  Process-based sockets, commonly referred to as <em>inter-process communication (IPC) sockets</em> or <em>unix domain sockets</em>, are generally meant for communicating between applications within the operating system. This does <em>not</em> necessarily mean these sockets are inaccessible from the network. It only means they are not explicitly bound to an IP address and port number. <em>Unix domain sockets</em> allow for TCP and UDP packets while the somewhat similar <em>named pipes</em> in Windows allow for TCP packets.  This may be useful in unix-based systems for broadcast messages.  Any limitations with these file-based sockets will be limitations on the transport (TCP or UDP/datagrams).</p>

<p>An example of a <em>unix domain socket</em> is the <em>iface_socket</em> one would find in <em>~/.dropbox</em> (see <a href="http://www.dropbox.com/install?os=lnx">dropbox.com</a> for download details).  Connecting to this socket and viewing activity is fairly easy.  Here, I have connected to the <em>unix domain socket</em> and subsequently edited <em>~/Dropbox/Example.txt</em> in gedit.</p>

<pre class="prettyprint"><code>$ nc -Ud /home/jim/.dropbox/iface_socket 
shell_touch
path    /home/jim/Dropbox/.goutputstream-J48D9V
done
shell_touch
path    /home/jim/Dropbox
done
shell_touch
path    /home/jim/Dropbox/Example.txt~
done
shell_touch
path    /home/jim/Dropbox/Example.txt
done
shell_touch
path    /home/jim/Dropbox/.goutputstream-J48D9V
done
shell_touch
path    /home/jim/Dropbox/Example.txt~
done
shell_touch
path    /home/jim/Dropbox/Example.txt
done
shell_touch
path    /home/jim/Dropbox
done</code></pre>

<p>I apologize for the length of output here.  Dropbox also provides a <em>command_socket</em> which allows you to enter commands for processing.  Instead of focussing too much on <em>unix domain sockets</em> right now, we will start with some TCP/IP examples. The application <code>nc</code> is the &#39;netcat&#39; utility used to connect to file-based sockets.  It can also connect to network-based sockets and the manpage says it is scriptable whereas <code>telnet</code> is not.  Because Windows users may not have access to <code>nc</code>, we will use <code>telnet</code> for network-based sockets.</p>

<h2 id="tCP_IP_Servers">TCP/IP Servers</h2>

<p>Many times, a server will do two things: write data to the console (or, <em>stdout</em>) and send data to a client connection.  Below is a simple TCP server which echos &quot;You were connected!&quot; to a client connection and outputs &quot;A client has connected!&quot; to <em>stdout</em>.</p>

<pre class="prettyprint"><code>// tcp/tcp_server.js
var sys = require(&#39;sys&#39;);
var net = require(&#39;net&#39;);
var server = net.createServer({ allowHalfOpen:false }, function(socket) {
    sys.puts(&quot;A client has connected!&quot;);
    socket.write(&quot;You were connected!\n&quot;, &quot;utf8&quot;);
    socket.end();
}).listen(8000, &#39;127.0.0.1&#39;);</code></pre>

<p>To test this server, enter <code>node src/tcp/tcp_server.js</code> in a terminal.  Then, open another terminal to telnet into this server.</p>

<pre class="prettyprint"><code>$ telnet 127.0.0.1 8000</code></pre>

<p>In the terminal running the server, you should see the message output from <code>sys.puts</code>, while the client terminal should display, &quot;You were connected!&quot;.  Because this is TCP/IP, an address is made up of an IP address and a port number. The <code>listen()</code> function accepts the port and IP address used to bind this network-based socket.  On the other end, <code>telnet</code> requires the IP address and the port number.  If you were to execute <code>telnet</code> without a port number, the default port defined in <em>/etc/services</em> would be used.  Grepping this file for &#39;telnet&#39; should yield:</p>

<pre class="prettyprint"><code>$ cat /etc/services | grep telnet
telnet      23/tcp
rtelnet     107/tcp             # Remote Telnet
rtelnet     107/udp
telnets     992/tcp             # Telnet over SSL
telnets     992/udp
tfido       60177/tcp           # fidonet EMSI over telnet</code></pre>

<p>So, invoking <code>telnet 127.0.0.1</code> may look like the program accepts an incomplete network socket address (missing port), but the operating system knows and understands these defaults.</p>

<p>It is important to understand that TCP server applications provide a &quot;service&quot; in the sense that a client makes a request and a server reponds. For example, HTTP is the ubiquitous protocol of internet web pages which uses the TCP/IP stack. In the TCP/IP protocol suite, an HTTP server and an HTTP client (or, browser) would exist at the <em>Application</em> layer, while the <code>net</code> module would handle the <em>Transport</em> layer and below. The HTTP protocol defines how a client makes a request and how a server responds to that request.</p>

<p>Because we have not discussed TCP clients yet and the first server example of this section provides a service of echoing the obvious, we should take a look at a TCP server example that does something (somewhat) useful-- allows the client user to enter contacts.</p>

<pre class="prettyprint"><code>// src/tcp/tcp_contact_server.js
var sys = require(&#39;sys&#39;),
    net = require(&#39;net&#39;),
    util = require(&#39;util&#39;),
    port = 9108,
    contacts = [];

// ... some code omitted

var opt = { allowHalfOpen: false };
var server = net.createServer(opt, function(socket) {
    socket.write(&#39;Welcome to the contact manager!\n&#39;);
    socket.on(&#39;data&#39;, function(d) {
        var s = socket;
        onData(s, d);
    });
    showHelp(socket);
});

server.on(&#39;connection&#39;, function(socket) {
    sys.puts(&#39;Client connected! (&#39; + socket.remoteAddress + &#39;)&#39;);
});

server.listen(port, &#39;localhost&#39;, function() {
    sys.puts(&#39;TCP server listening on port &#39; + port);
});</code></pre>

<p>This is quite a bit of code to start.  You may have noticed that <code>net.createServer</code> and <code>.listen()</code> are no longer chained.  This is to make room for the &#39;connection&#39; event binding.  Whenever a client connects to this server, we will write a message to <em>stdout</em>.  The <code>.listen()</code> function also accepts a callback function as the third argument. This function executes after the server is created successfully. It is not only important to give feedback to the client of an application, it is also important to provide some sort of output locally whether it is status messages, debug messages, or error messages.</p>

<p>The <code>showHelp(socket);</code> call will write a help message to the socket to which the client application is connected.  This help message resembles:</p>

<pre class="prettyprint"><code>Commands: [quit help save list]
    quit- closes the connection
    help- displays this message
    save- saves the contact. e.g save Jim Schubert
    list- displays the list of contacts</code></pre>

<p>The &#39;data&#39; event captures a reference to the <code>socket</code> and passes it to the <code>onData</code> function along with the data from the client.  Although the documention for the <code>net</code> module claims this data may be either a <code>Buffer</code> or a <code>String</code>, play it safe and call <code>toString()</code> on that data. </p>

<p>When a command is accepted from the client (the <code>d</code> passed to the emitted <code>&#39;data&#39;</code> event), the <code>onData</code> function does some processing on the data to determine the command (which we have limited to 4 letters) and any parameters, writing a status message to <em>stdout</em>:</p>

<pre class="prettyprint"><code>var arg = buffer.toString().replace(&#39;\r\n&#39;, &#39;&#39;);
var command = arg.substring(0,4);
sys.puts(&#39;Received data: &#39; + command);</code></pre>

<p>The function then switches on each of the known commands, writing out the response to the client. If a command is not known, or is in a format that is unexpected (it is case-sensitive), a message is written to the client that the command is invalid.  The &#39;save&#39; case may be handled like this:</p>

<pre class="prettyprint"><code>var toSave = arg.replace(command,&#39;&#39;).trim();
if(toSave) {
    contacts.push(toSave);
    socket.write(toSave + &#39; was saved\n&#39;);
} else {
    socket.write(&#39;Syntax is: save FirstName LastName\n&#39;);
}</code></pre>

<p>Because <code>save</code> and <code>save FirstName LastName</code> are both valid commands received from the client, the parameter(s) can be determined by removing the command from the line. If the result is <code>&#39;&#39;</code>, no parameters were given and a message is displayed to the client.</p>

<p>Try this example by again opening two terminals.  In the first terminal, run:</p>

<pre class="prettyprint"><code>$ node src/tcp/tcp\_contact\_server.js</code></pre>

<p>In the second terminal, connect by running <code>telnet localhost 9108</code>. Try saving two or three names, then send the <code>quit</code> command.  Reconnect and issue the <code>list</code> command. You&#39;ll notice that although we didn&#39;t persist the contacts to some persistent storage, it remains resident in memory as long as the server application is running.  Depending on your comfort with client-server technologies, this may seem like a basic concept. In any case, it is always important to be mindful of resources in your server application.</p>

<h2 id="tCP_Clients">TCP Clients</h2>

<p> ...</p>

<h1>HTTP</h1>

<p>Node&#39;s HTTP module offers a chunkable, buffered interface to the HTTP protocol.  Headers are JSON objects with lower-case keys and original values.</p>

<pre class="prettyprint"><code>{ &#39;content-length&#39;: &#39;123&#39;, &#39;content-type&#39;: &#39;text/plain&#39; }</code></pre>

<p>The HTTP module is low-level, meaning it handles the headers and the message (and that&#39;s about it).  This creates a solid framework ontop of which modules can be built for web frameworks (<a href="http://www.expressjs.com">express</a>, <a href="http://www.geddy.com">geddy</a>, file servers, browsers (<a href="http://www.google.com/?q=zombiejs">zombie.js</a>, and even SaaS (<a href="http://www.cloud9ide.com)">cloud9 IDE</a>.</p>

<p>Let&#39;s take a look at the <code>request</code> and <code>response</code> objects of an HTTP server created by node.  To do this, we&#39;re going to create a server, inspect both of these objects in the request, and write a dump of the inspection out to a file.</p>

<pre class="prettyprint"><code>// http/view_request.js
var http = require(&#39;http&#39;), 
fs = require(&#39;fs&#39;), 
util = require(&#39;util&#39;),
tty = require(&#39;tty&#39;);

var server = http.createServer(function(req, res) {
    console.log(&quot;Received a request!&quot;);
    fs.writeFile(&#39;./request.txt&#39;, util.inspect(req) );
    res.writeHead(200, { &#39;Content-Type&#39; : &#39;text/html&#39; });
    res.write(&quot;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;p&gt;We&#39;re serving up html!&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;);
    res.end();
    fs.writeFile(&#39;./response.txt&#39;, util.inspect(res) );
});

// ... cleanup on exit (see file)

console.log(&quot;Server is running on http://localhost:9111&quot;);
console.log(&quot;Hit CTRL+C to shutdown the http server&quot;);</code></pre>

<p>Run this sample with <code>node src/http/view_request.js</code> from a terminal.  Then, navigate to the server location displayed in the terminal.  This will generate two files: <code>./src/http/request.txt</code> and <code>./src/http/response.txt</code>.</p>

<p><em>!IMPORTANT!</em> You must always remember to provide a way to close a server.  Leaving an open server running developmental code can be a security risk.</p>

<h2 id="hTTP_Request">HTTP Request</h2>

<p>Let&#39;s take a look at what the request object looks like from the server example above. You should see output similar to:</p>

<pre class="prettyprint"><code>// http/request.txt
// ...
httpVersion: &#39;1.1&#39;,
  complete: false,
  headers: 
   { host: &#39;localhost:9111&#39;,
     connection: &#39;keep-alive&#39;,
     accept: &#39;*/*&#39;,
     &#39;user-agent&#39;: &#39;Mozilla/5.0 (X11; Linux i686) AppleWebKit/534.24 (KHTML, like Gecko) Chrome/11.0.696.14 Safari/534.24&#39;,
     &#39;accept-encoding&#39;: &#39;gzip,deflate,sdch&#39;,
     &#39;accept-language&#39;: &#39;en-US,ru;q=0.8&#39;,
     &#39;accept-charset&#39;: &#39;ISO-8859-1,utf-8;q=0.7,*;q=0.3&#39; },
  trailers: {},
  readable: true,
  url: &#39;/favicon.ico&#39;,
  method: &#39;GET&#39;,
  statusCode: null, 
// ...</code></pre>

<h2 id="hTTP_Response">HTTP Response</h2>

<p>Let&#39;s take a look at what the request object looks like from the server example above. You should see output similar to:</p>

<pre class="prettyprint"><code>{ output: [],
  outputEncodings: [],
  writable: true,
  _last: false,
  chunkedEncoding: true,
  shouldKeepAlive: true,
  useChunkedEncodingByDefault: true,
  _hasBody: true,
  _trailer: &#39;&#39;,
  finished: true,
  socket: null,
  connection: null,
  _events: { finish: [Function] },
  _header: &#39;HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nConnection: keep-alive\r\nTransfer-Encoding: chunked\r\n\r\n&#39;,
  _headerSent: true }</code></pre>

<h2 id="hTTP_Servers">HTTP Servers</h2>

<p>http.Server exposes a number of events (request, connection, close, response, etc.) and three functions for creation, listening for requests, and closing the server.  We saw examples of a few of these at the beginning of this section. Up to this point, most of the code we&#39;ve looked at has been mainly procedural.  To create a server, we will have to implement quite a few things we&#39;ve learned up to this point:</p>

<ul><li>Write a module for an http server</li><li>Expose events which occur on the server</li><li>Serve/compile files</li></ul>

<p>Like the first example in this chapter, we&#39;ll be using the <em>http</em>, <em>fs</em> and <em>tty</em> modules.  To make this interesting, though, we&#39;ll also do a compilation from markdown to html so that our server is doing a little more than serving static files. To simplify the example, we won&#39;t also be serving static files or even sending a full range of HTTP status codes; everything is <code>200 OK</code> in this example.</p>

<h3 id="creating_the_module">Creating the module</h3>

<p>Our module will be located at <code>./src/http/server/</code>.  The directory is structured in the following way:</p>

<pre class="prettyprint"><code>$ ls -l
total 20
drwxr-xr-x 3 jim jim 4096 2011-03-23 16:31 lib
-rw-r--r-- 1 jim jim   56 2011-03-23 17:13 package.json
drwxr-xr-x 2 jim jim 4096 2011-03-24 07:25 pages
-rw-r--r-- 1 jim jim 3034 2011-03-24 07:57 server.js
drwxr-xr-x 2 jim jim 4096 2011-03-23 20:31 templates</code></pre>

<p>The file <code>server.js</code> is our module.  So we don&#39;t need to call <code>var server = require(&#39;./server/server.js&#39;)</code> at the top of our node application, we&#39;re also going to include <code>package.json</code> which specifies where the main routine for our module is located.</p>

<pre class="prettyprint"><code>// http/server/package.json
{ &quot;name&quot; : &quot;example server&quot;,
  &quot;main&quot; : &quot;./server.js&quot; }</code></pre>

<p>Recall from the <em>Modules</em> chapter that it is also possible to include an <code>index.js</code> file.  </p>

<p>Next, let&#39;s identify the functionality we&#39;ll require in this module.  First, we know that we&#39;ll have to read a file.  We&#39;ll call that function <code>getFile()</code>. Then, since we&#39;re simplifying things for example&#39;s sake, we&#39;re assuming all files are in markdown format and converting all files to html.  We&#39;ll call that function <code>getHtml()</code>.  I know, I&#39;m really creative.</p>

<p>Finally, we&#39;ll have a function called <code>run()</code> which creates the server and listens on the specified port.  To make our module useful, we have to expose functionality which, in our case, is only the run method.  Here is how we will interface with our module:</p>

<pre class="prettyprint"><code>// http/server_example.js
var server = require(&#39;./server&#39;);
server.run({ port: 9222 });</code></pre>

<p>We also have the option of performing a function before starting the server:</p>

<pre class="prettyprint"><code>server.run({ port: 9222, 
    beforeStart: function(){ 
        console.log(&quot;before start&quot;);
    } 
});</code></pre>

<p>Now that we have a plan in place for the interaction with the module, let&#39;s take a look at the three functions, <code>getFile()</code>, <code>getHtml()</code>, and <code>run()</code>.</p>

<h3 id="getFile">getFile(request)</h3>

<p>The <code>getFile()</code> function assumes that all requests occur at the base of the server&#39;s uri. It also ignores requests for <code>/favicon.ico</code> and for the base uri <code>/</code>.  It then builds a full path to the file and attempts to read the file in a single blocking call. This blocking call helps ensure that we&#39;re passing data correctly to the Markdown module.</p>

<pre class="prettyprint"><code>// http/server/server.js
var getFile = function(request) {
    if(!request) {
        console.log(&quot;getFile called with empty request&quot;);
        noop();
    }

   var callback = arguments[arguments.length - 1];
   if (typeof(callback) !== &#39;function&#39;) callback = noop;

   var filename = url.parse(request).pathname.replace(&#39;html&#39;, &#39;md&#39;);
   if(filename === &quot;/favicon.ico&quot;) return;
   if(filename === &quot;/&quot; || filename === &quot;&quot;) { filename = &quot;/index.md&quot;; }

   var requestedFile = __dirname + &#39;/pages&#39; + filename;

   console.log(&#39;Requested: &#39; + requestedFile);
   var data = fs.readFileSync(requestedFile, &quot;utf8&quot;);
   callback(data);
};</code></pre>

<p>This function uses the same pattern of identifying a callback as the node libraries.  The <code>noop()</code> function is defined as <code>var noop = function() { };</code> which saves us from creating numerous empty callbacks and checking for functions where those callbacks are required.  For those unfamiliar with the term <em>noop</em>, it means the function performs <strong>no op</strong>eration.</p>

<h3 id="getHtml">getHtml(request)</h3>

<p>The second function in our module performs the conversion between markdown and html.  It does this in the callack to the <code>getFile()</code> function, transforms the markdown to html, and passes the result to its own callback. </p>

<pre class="prettyprint"><code>// http/server/server.js
var getHtml = function(request) {
    var callback = arguments[arguments.length - 1];
    if (typeof(callback) !== &#39;function&#39;) callback = noop;

    // get the data and call markdown
    try {
        getFile(request, function(data) {
            if(!data) { 
                callback(&quot;Nothing to see here!&quot;);
            }
            var html = template.replace(&quot;{{content}}&quot;, markdown.toHTML(markdown.parse(data), {xhtml:true}));
            console.log(html);
            callback(html);
        }); 
    } catch(err) {
        console.log(err);
        callback(&quot;Nothing to see here!&quot;);
    }
}; </code></pre>

<p>If there are any errors, it returns a string: &quot;Nothing to see here!&quot; A message like this usually accompanies a <code>404 - Not Found</code> HTTP status, but we&#39;re keeping this pretty simple.</p>

<h3 id="run">run()</h3>

<p>The run function requires the following server to be created.  The <code>requestListener</code> function calls <code>getHtml</code> and writes the html to the response.  Here, we&#39;re using a buffer to get the proper byte length and attempt to output a properly-encoded html string.</p>

<pre class="prettyprint"><code>// http/server/server.js
var server = http.createServer(function(req, res) {
    getHtml(req.url, function(html) {
        var buf = new Buffer(html, &quot;utf8&quot;);
        res.writeHead(200, { &#39;Content-Type&#39; : &#39;text/html&#39;, &#39;Content-Length&#39; : buf.length });
        res.write(buf.toString());
        res.end();
    });
});</code></pre>

<p>Next, the run function sets the options we&#39;re allowing (port number and a function to call before starting the server).  We&#39;re also catching all errors and logging the output to the console.  </p>

<pre class="prettyprint"><code>// http/server/server.js
var run = function(opts) {
    try {
        if(opts &amp;&amp; typeof opts[&#39;beforeStart&#39;] === &#39;function&#39;){
            opts[&#39;beforeStart&#39;]();
        }
        var port = (opts &amp;&amp; opts.port) || 9111;

        // ... Removed CTRL+C interrupt code from previous example

        server.listen(port, function() {
            console.log(&quot;Server is running on http://localhost:&quot; + port);
            console.log(&quot;Hit CTRL+C to shutdown the http server&quot;);
        });
    } catch(err) {
        console.log(err);
    }
};</code></pre>

<p>Notice how we&#39;ve moved the console logging to the <code>server.listen</code> callback.  This makes more sense than the procedural example from before- if the port isn&#39;t available and <code>server.listen</code> throws an error, you don&#39;t want to tell the developer that the server has started!  This is how things should be programmed, and it&#39;s part of what makes node.js so awesome.</p>

<h3>Exposing <code>run()</code></h3>

<p>The last thing to do to make our module run is to expose the run function.  To revisit from the <em>Modules</em> chapter, you can do this a few ways:</p>

<pre class="prettyprint"><code>// 1. Multiple assignment
var server = exports.server = http.createServer(requestListener);

// 2. Inline assignment
exports.server = http.createServer(requestListener);

// 3. Post-facto assignment
var server = http.createServer(requestListener);
exports.server = server;</code></pre>

<p>There&#39;s no &#39;correct&#39; method, and each has it&#39;s benefits. Please refer to the <em>Best Practices</em> section for more information.</p>

<h3 id="run_it_">Run it!</h3>

<pre class="prettyprint"><code>$ node src/http/server_example.js 
Server is running on http://localhost:9222
Hit CTRL+C to shutdown the http server</code></pre>

<p>After receiving the output to confirm the server is running, visit <a href="http://localhost:9222">http://localhost:9222</a> to check it out.  Then, hit <code>CTRL+C</code> to be sure the server&#39;s <code>close</code> function is working as expected.</p>

<h3 id="where_are_the_events_">Where are the events?</h3>

<p>You may have noticed that we met only half of the requirements with the above implementation of our server.  To expose events, our <code>run</code> method would have to inherit from <code>EventEmitter</code>. That doesn&#39;t <em>really</em> make sense.  For the sake of simplicity and brevity, we previously only had three methods.  We had no class-like objects, and we didn&#39;t touch an object&#39;s prototype.  Also, the three methods we did have didn&#39;t make good use of callbacks.  So, there is another take on this example at <em>./src/http/server/server2.js</em>.</p>

<p>This is set up so that our <code>run</code> function returns our <code>Example</code> object. This object has properties for our configurables (such as the pages directory, template name, etc.).  It also has the functions from the previous example, which have been slightly refactored.</p>

<p>First, you&#39;ll notice the inheritence of the <code>Example</code> object from <code>EventEmitter</code>:</p>

<pre class="prettyprint"><code>// http/server/server2.js
util.inherits(Example, EventEmitter);</code></pre>

<p>This allows us to call <code>this.emit(&#39;eventName&#39;)</code> at different times in our code, which executes all of the listeners bound to these events in the order they were declared.</p>

<p>Now, at different points of the code, you&#39;ll see a <code>this.emit()</code> or <code>self.emit()</code> call.  For instance, in the <code>getServer</code> function, we emit the <code>request</code> and <code>requestComplete</code> events.</p>

<pre class="prettyprint"><code>// http/server/server2.js
Example.prototype.getServer = function() {
	var self = this, ct = &#39;text/html; charset=utf-8&#39;;
	return http.createServer(function(req, res) {
		self.emit(&#39;request&#39;, req.url);
		self.getHtml(req.url, function(html) {
			var buf = new Buffer(html, &quot;utf8&quot;);
			res.writeHead(200, 
				{ 
					&#39;Content-Type&#39; : ct, 
				 	&#39;Content-Length&#39; : buf.length 
			 	});
			res.write(buf.toString());
			res.end();
			self.emit(&#39;requestComplete&#39;);
		});
	});
};</code></pre>

<p>Because we know that all responses will be <em>html</em>, the request comes in and immediate emits the <code>request</code> event.  Our <code>getHtml</code> function is written to do one of two things. First, it gets a valid string of html, emits it as <em>data</em> to the <code>data</code> event, then passes it to <code>getHtml</code>&#39;s callback as the <em>html</em> parameter, which ultimately writes that string to the response. </p>

<p>The alternative is when a request is ignored either explicitly with the <code>option.ignorePaths</code> array, or implicitly by <code>fs.readFileSync</code> throwing an error.  Either way, we emit the <code>data</code> event with the content as &quot;ignored&quot;.  The <code>getHtml</code> function above then writes an empty response.</p>

<p><strong>Note:</strong> <code>http.ServerRequest</code>, the type of the <code>request</code> parameter in the <em>requestListener</em> passed to <code>http.createServer</code>, emits its own <em>data</em> and <em>end</em> events.  Instead of emitting our own events, we could expose the existing events instead of emitting completely new and renamed events.</p>

<h2 id="hTTP_Clients">HTTP Clients</h2>

<p>Node also provides client functionality in the <em>http</em> module.  To begin with the http client functionality, we&#39;re going to open one terminal and run the server from the previous example: <code>node src/http/server_example2.js</code>.  The first client code we&#39;re going to run is slightly modified from node&#39;s v0.4.0 documentation.  </p>

<h3 id="http.get">http.get(options, callback)</h3>

<p>This example uses the <code>http.get</code> function.  This function is a wrapper around the <code>http.request</code> function which assumes that a get doesn&#39;t write a body to the server request, ultimately only expecting a response.  If you&#39;re familiar with jQuery, node&#39;s <code>http.get</code> is a wrapper around <code>http.request</code> in much the same way as jQuery&#39;s <code>$.get</code> is a wrapper around the <code>$.ajax</code> function; the big difference is that in node, we&#39;re not working with an <em>XmlHttpRequest</em> object-- we&#39;re working directly with <em>sockets</em> and <em>streams</em>.</p>

<pre class="prettyprint"><code>// http/http_get.js
var http = require(&#39;http&#39;),
	util = require(&#39;util&#39;);

var opt = {
	host: &#39;localhost&#39;,
	port: 9222,
	path: &#39;/index.html&#39;
};

http.get(opt, function(response) {
	console.log(&quot;http.get [Status]: %s&quot;, response.statusCode);
	console.log(&quot;http.get [method]: %s&quot;, response.client._httpMessage.method);
	console.log(&quot;http.get [path]: %s&quot;, response.client._httpMessage.path);
	console.log(&quot;http.get [method]:\n%s&quot;, response.client._httpMessage._header);
	// console.log(&quot;http.get [client]:\n%s&quot;, util.inspect(response.client));
}).on(&#39;error&#39;, function(err) {
	console.log(&quot;http.get [Error]: &quot; + err.message);
});</code></pre>

<p><strong>Note: see the Globals chapter for information on <code>err.errno</code> constants</strong></p>

<p>With the server from the previous example running, we can run the <em>./src/http/http</em>get.js_ example and examine the output.</p>

<pre class="prettyprint"><code>$ node src/http/http_get.js 
http.get [Status]: 200
http.get [method]: GET
http.get [path]: /index.html
http.get [method]:
GET /index.html HTTP/1.1
Host: localhost
Connection: close</code></pre>

<p>If you&#39;d like to view the full client object, uncomment the last line from the callback in the file <em>./src/http/http</em>get.js_.  </p>

<h2 id="url_Module">Url Module</h2>

<p> ...</p>

<h2 id="micro_Frameworks">Micro-Frameworks</h2>

<h3 id="geddy">Geddy</h3>

<p>...</p>

<h3 id="zombieJS">ZombieJS</h3>

<p>...</p>

<h3 id="cloud9_IDE">cloud9 IDE</h3>

<p>...</p>

<h1>HTTPS</h1>

<h2 id="hTTPS_Server">HTTPS Server</h2>

<h2 id="hTTPS_Client">HTTPS Client</h2>

<h1>Connect</h1>

<p>Connect is a ...</p>

<h1>Express</h1>

<p><a href="www.expressjs.com">Express</a> is a robust and feature-rich web application framework for node.js written by TJ Holowaychuk, Ciaran Jessup, Aaron Heckmann, and Guillermo Rauch.  </p>

<h2 id="install">Install</h2>

<h2 id="simple_First_Project">Simple First Project</h2>

<h1>Testing</h1>

<p>Testing is a very large topic.  There are different types of testing, each with different methodologies.  Then, there are also strong feelings of developers toward which type of testing is the best or most effective.</p>

<ul><li>Assertion Testing<ul><li>Tests a true or false condition against known objects or values</li></ul></li><li>Behavioral Testing<ul><li>Tests how one object acts when interacting with another</li></ul></li><li>Functional/Acceptance Testing<ul><li>&quot;Black box&quot; testing of a system, usually code-agnostic</li></ul></li><li>Regression Testing<ul><li>Tests for consistency after changes have been made to code</li></ul></li><li>Others...</li></ul>

<p>There are many other types of testing, but these are some large topics in the testing arena.  Development practices include Test-Driven Development (TDD), Behavior-Driven Development, and others. Some programmers don&#39;t believe in testing, others believe tests should be written before the code, while others still believe tests should only be written for the most important code.  As you can see, this is a large and complex topic.</p>

<p>Whether you write tests before you code, test only the most important code, or casually write tests when there is time, it is important to choose a testing tool that fits your needs.</p>

<h2 id="assert_Module">assert Module</h2>

<p>To begin, require the assert module:</p>

<pre class="prettyprint"><code>var assert = require(&#39;assert&#39;);</code></pre>

<p>This module exposes a few functions common to assertion testing:</p>

<pre class="prettyprint"><code>// equality
assert.equal(actual, expected, [message])
assert.notEqual(actual, expected, [message])
assert.deepEqual(actual, expected, [message])
assert.notDeepEqual(actual, expected, [message])
assert.strictEqual(actual, expected, [message])
assert.notStrictEqual(actual, expected, [message])

// exception
assert.throws(block, [error], [message])
assert.doesNotThrow(block, [error], [message])
assert.ifError(value)

// condition
assert.ok(value, [message])
assert.fail(actual, expected, message, operator)</code></pre>

<p>These are pretty self-explanatory if you&#39;ve written assertion tests before. Let&#39;s look at a pretty simple test, anyway.  We&#39;ll code in an object for the test that will do what we want for each test.</p>

<h3 id="synchronous_Testing_with_Assert">Synchronous Testing with Assert</h3>

<pre class="prettyprint"><code>// testing/equality_no_errors.js
var assert = require(&#39;assert&#39;),
    tester_a = {
      val : &#39;a&#39;
    }, 	
    tester_b = {
      val : &#39;b&#39;
    };

assert.equal(tester_a.val, &#39;a&#39;);
assert.equal(tester_b.val, &#39;b&#39;);</code></pre>

<p>In this example, we&#39;re using the assert module to check that a value on each of these objects is the expected value.  This works well because the values are equal.  But, the assert module throws an <code>AssertionError</code> whenever an assertion fails.  So, it doesn&#39;t really make sense to have a single file with end-to-end assertions as in the <code>./src/testing/equality\_no\_errors.js</code> file.  This is where testing frameworks like <em>nodeunit</em> or <em>expresso</em> come in very handy.  They offer common functionality of test frameworks (like metrics, etc.).</p>

<p>To see how the <code>AssertionError</code> being thrown from <code>assert.equal</code> can be problematic, change the expected value in the first test to an incorrect value.  Then, change the expected value in the very last test to an incorrect value and run <code>node src/testing/equality_no_errors.js</code> again.  You&#39;ll see that, because of the procedural style of the code, the last test never runs!  </p>

<p>In order to run multiple assertions and provide feedback, the simplest test (without a testing framework) would use a <code>try/catch</code> and provide output to <em>stdout</em>.</p>

<pre class="prettyprint"><code>// testing/equality_with_errors.js
var assert = require(&#39;assert&#39;),
    tester_a = {
      val : &#39;aa&#39;
    }, total = 0, good = 0;

// assert.equal(actual, expected, [message])
try {
    console.log(&quot;assert.equal(tester_a.val, &#39;a&#39;)&quot;);
    assert.equal(tester_a.val, &#39;a&#39;);
    passed();
} catch (err) { writeException(err); }

console.log(&quot;%d of %d tests passed&quot;, good, total);

function writeException(err) {
    console.log(&quot;Test failed!&quot;);
    util.inspect(err);
    if(err[&quot;name&quot;] === &quot;AssertionError&quot;) {
        console.log(&quot;Message: &quot; + (err[&quot;message&quot;] || &quot;None&quot;));
        console.log(&quot;Expected: &quot; + err[&quot;expected&quot;]);
        console.log(&quot;Actual: &quot; + err[&quot;actual&quot;]);
        console.log(&quot;Operation: &quot; + err[&quot;operator&quot;]);
    }
    console.log(&quot;&quot;);
    total = total + 1;
}

function passed() {
    good = good + 1;
    total = total + 1;
    console.log(&quot;Test passed!\n&quot;);
}</code></pre>

<p>The above code is part of the code from within <em>./src/testing/equality_with_errors.js</em>.  It shows how to run synchronous tests with a minimal amount of redundant code, <em>without</em> writing a lightweight testing module for your tests.  This may be what you want, but most likely it isn&#39;t.</p>

<h3 id="the_problems">The problems</h3>

<p>You <em>could</em> write a simple helper module to run these tests for you.  But, how do you verify the order of your tests?  This can become complex very quickly.</p>

<p>You can partially resolve this with the <code>try/catch</code> block example above, but this requires a lot of redundant code.  Compare <em>./src/testing/equality_with_errors.js</em> and <em>./src/testing/equality_no_errors.js</em> to see how the testing quickly expands!  Run <code>node testing/equality_with_errors.js</code> to see the output.  That&#39;s more like it! Isn&#39;t that nice?  </p>

<p>Yes and no.  There are a few problems with this code: </p>

<ol><li>It isn&#39;t evented</li><li>It hard-codes test objects</li><li>It is very redundant</li><li>It isn&#39;t scalable</li></ol>

<p>Well, then, <em>what are other options?</em></p>

<h2 id="nodeunit">Nodeunit</h2>

<p><a href="https://github.com/caolan/nodeunit">Nodeunit</a> is a framework similar to nunit in that it allows for multiple test cases (running in parallel), and supports mocks and stubs.  It is easy to use, and even allows you to run tests in the browser.</p>

<p>Nodeunit testing starts with exporting a test or two from a module.</p>

<pre class="prettyprint"><code>// testing/nodeunit_basics.js
module.exports = {
    &#39;Test 1&#39; : function(test) {
        test.expect(1);
        test.ok(true, &quot;This shouldn&#39;t fail&quot;);
        test.done();
    },
    &#39;Test 2&#39; : function(test) {
        test.expect(2);
        test.ok(1 === 1, &quot;This shouldn&#39;t fail&quot;);
        test.ok(false, &quot;This should fail&quot;);
        test.done();
    }
};</code></pre>

<p>Here, we have a module exporting two tests, <code>Test 1</code> and <code>Test 2</code>.  You may have noticed that the <code>test</code> object in the functions have an <code>ok()</code> method just like the <code>assert</code> module mentioned above.  Good eye.  In fact, <code>test</code> supports all of the assert functions and adds two others: <code>expect(number)</code> and <code>done()</code>.  The <code>expect</code> function tells nodeunit how many tests are being run within the context of the current test case.  When all tests are finished, call <code>test.done()</code> to let nodeunit know the test case has completed (and a callback may have failed).</p>

<p>The output of nodeunit is visually helpful.  </p>

<pre class="prettyprint"><code>$ nodeunit src/testing/nodeunit_basics.js 

nodeunit_basics.js
✔ Test 1
✖ Test 2

Assertion Message: This should fail
AssertionError: false == true
    at Object.ok (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/types.js:81:39)
    at /home/jim/projects/masteringnode/src/testing/nodeunit_basics.js:10:14
    at Object.runTest (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/core.js:54:9)
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/core.js:90:21
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:508:13
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:118:25
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:129:25
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:510:17
    at Array.&lt;anonymous&gt; (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/types.js:144:17)
    at EventEmitter._tickCallback (node.js:108:26)


FAILURES: 1/3 assertions failed (8ms)</code></pre>

<p>Nodeunit will list all test cases run within the test, followed by any <code>AssertionError</code> output and the number of passing or failing assertions.  This is the default (minimal) output.  </p>

<h3 id="nodeunit_reporters">Nodeunit reporters</h3>

<p>Nodeunit ships with a number of reporters and it is possible to add custom reporters.  </p>

<pre class="prettyprint"><code>$ nodeunit --list-reporters
Build-in reporters: 
  * default: Default tests reporter
  * minimal: Pretty minimal output
  * junit: jUnit XML test reports
  * html: Report tests result as HTML
  * skip_passed: Skip passed tests output
  * browser: Browser-based test reporter</code></pre>

<p>To output to junit, run the command as:</p>

<pre class="prettyprint"><code>$ cd src/testing &amp;&amp; nodeunit --reporter junit nodeunit_basics.js --output junit.out</code></pre>

<p>This creates an xml file (whitespace has been condensed):</p>

<pre class="prettyprint"><code>// testing/junit.out/nodeunit_basics.js.xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;testsuite name=&quot;nodeunit_basics.js&quot;
         errors=&quot;0&quot;
         failures=&quot;0&quot;
         tests=&quot;2&quot;&gt;
  &lt;testcase name=&quot;Test 1&quot;&gt;
  &lt;/testcase&gt;
  &lt;testcase name=&quot;Test 2&quot;&gt;
  &lt;/testcase&gt;
&lt;/testsuite&gt;</code></pre>

<p>This is great, but in a real-world development environment, you may be asked to write reports with a specific format, wording, or links (in html) to files with failing test cases.  Luckily, nodeunit allows us to customize this output.</p>

<h3 id="nodeunit_Custom_reporters">Nodeunit Custom reporters</h3>

<p>To write a custom reporter for nodeunit, first decide how you&#39;d like nodeunit to report information about your tests.  As a simple example, let&#39;s take a look at a different take on the <a href="https://github.com/caolan/nodeunit/blob/master/lib/reporters/minimal.js">minimal</a> reporter.</p>

<p>Here are the modifications I&#39;d like to see:</p>

<ul><li>Show the start time of the test</li><li>Show the filename as bold/green</li><li>Add <em>[PASS]</em> or <em>[FAIL]</em> after the <em>✔</em> or <em>✖</em></li><li>Prefix a test case with a &#39;|&#39;</li></ul>

<p>These may seem like contrived requirements.  But, what if my manager wants me to parse textual output for <em>[FAIL]</em> and, for whatever reason, it has to say <em>[FAIL]</em>?  </p>

<p>The modifications to the <em>minimal</em> reporter are too spread out to include inline here, so be sure to check out the file at <em>./src/testing/reporterse/example.js</em>.</p>

<p>Here is the slightly modified minimal output, meeting all of the requirements.</p>

<pre class="prettyprint"><code>$ cd src/testing &amp;&amp; nodeunit --reporter reporters/example.js nodeunit_basics.js 
Tests started: Tue Mar 22 2011 21:24:42 GMT-0700 (PDT)
nodeunit_basics.js: 

✔ [PASS] | Test 1
✖ [FAIL] | Test 2


AssertionError: false == true
    at Object.ok (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/types.js:81:39)
    at /home/jim/projects/masteringnode/src/testing/nodeunit_basics.js:10:14
    at Object.runTest (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/core.js:54:9)
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/core.js:90:21
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:508:13
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:118:25
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:129:25
    at /usr/local/lib/node/.npm/nodeunit/0.5.1/package/deps/async.js:510:17
    at Array.&lt;anonymous&gt; (/usr/local/lib/node/.npm/nodeunit/0.5.1/package/lib/types.js:144:17)
    at EventEmitter._tickCallback (node.js:108:26)


FAILURES: 1/3 assertions failed (9ms)</code></pre>

<p>These were small modifications, but following through the <a href="https://github.com/caolan/nodeunit/tree/master/lib/reporters">reporters included in nodeunit</a>, it will be easy to output test reports to your desired format.</p>

<h3 id="nodeunit_Mocks_and_Stubs">Nodeunit Mocks and Stubs</h3>

<p>  ...</p>

<h2 id="expresso">Expresso</h2>

<p>  ...</p>

<h2 id="vows">Vows</h2>

<p>  ...</p>

<h2 id="fixtures">Fixtures</h2>

<p>  ...</p>

<h1>Deployment</h1>

<p>Deploying an application depends on the host environment. Most shared hosts don&#39;t currently support node.js.</p>

<p>Heroku is a cloud-based hosting platform with support for Node.js.  It also supports Ruby, Clojure, Java, Python, and Scala.</p>

<p>Other hosting platforms include:<br></br>  <em> <a href="https://no.de">Joyent Node</a><br></br>  </em> <a href="http://www.windowsazure.com/en-us/develop/nodejs/tutorials/getting-started/">Windows Azure</a><br></br>  * <a href="http://aws.amazon.com/ec2/">Amazon EC2</a>  </p>

<p>The level of effort for hosting in these platforms varies.  Heroku is relatively simple.</p>

<h2 id="deploying_to_Heroku">Deploying to Heroku</h2>

<p>For complete instructions, refer to <a href="http://devcenter.heroku.com/articles/node-js">Heroku&#39;s Documentation</a>.</p>

<p>Assuming you have already created your app and an account on Heroku, the next step is to install the <a href="http://toolbelt.herokuapp.com/linux/readme">heroku-toolbelt</a>. In Debian/Ubuntu, this can be accomplished with:  </p>

<pre class="prettyprint"><code>$ sudo -s
$ echo &quot;deb http://toolbelt.herokuapp.com/ubuntu ./&quot; &gt; /etc/apt/sources.list.d/heroku.list
$ wget -q -O - http://toolbelt.herokuapp.com/apt/release.key | apt-key add -
$ apt-get update
$ apt-get install heroku-toolbelt</code></pre>

<p>Once installed, run the command <code>heroku login</code> and follow the prompts.</p>

<p>Next, in the root of your app directory, you will need to create a <em>Procfile</em> file containing:</p>

<pre class="prettyprint"><code>web: node app.js</code></pre>

<p>In this file, <code>node app.js</code> is the command you would normally use to run your app locally.  If your app requires parameters, either enter those on this line or modify your script to read defaults from <code>env</code>.</p>

<p>The Heroku documentation for deploying a node.js suggests you test the <em>Procfile</em> using <em>foreman</em>.  This isn&#39;t a necessity.  However, if you want to install <em>foreman</em>, instructions for Ubuntu can be found <a href="http://theforeman.org/projects/foreman/wiki/Debian-Ubuntu_installation_by_packages">here</a>.</p>

<p>Next, you&#39;ll need to create a cedar stack and push your code to heroku:</p>

<pre class="prettyprint"><code>$ heroku create --stack cedar
$ git push heroku master</code></pre>

<p>You&#39;ll also need to configure some settings on heroku using the toolbelt.  You&#39;ll need to set web scaling to 1 and <code>NODE_ENV=production</code>:  </p>

<pre class="prettyprint"><code>$ heroku ps:scale web=1
$ heroku config:add NODE_ENV=production</code></pre>

<p>With the heroku toolbelt, you can also run commands within your cedar stack.  Try the following to become familiar with the toolbelt:  </p>

<pre class="prettyprint"><code>$ heroku ps
$ heroku logs
$ heroku run node</code></pre>

<p>Heroku also offers free database addons (postgresql, redistogo, etc.). There are also services such as <a href="http://www.iriscouch.com/">Iris Couch</a> which offer free services that are not tied to the heroku service.</p>

<p>At any time, you can login to heroku.com and modify settings for your newly-created cedar stack.  You can also opt-in to logging, notifications, and a plethora of other free and paid services.</p>

  </div>
  <script type="text/javascript">
    (function() { prettyPrint(); }());
  </script>
</body>
</html>
